# Test Specification: TC-I-004-01

## Test Metadata

| Field | Value |
|-------|-------|
| **Test ID** | TC-I-004-01 |
| **Test Type** | Integration Test |
| **Requirement** | FR-004 (Database Synchronization) |
| **Priority** | HIGH |
| **Estimated Effort** | 30 minutes |

---

## Test Description

**Objective:** Verify that `GlobalParams::init_from_database()` successfully loads all 15 parameters from SQLite database

**Scope:** Database query, value parsing, parameter initialization

---

## Test Specification (BDD Format)

### Given
- Test SQLite database exists with settings table
- All 15 parameters have entries in settings table with valid values
- GlobalParams singleton exists with default values

### When
- `GlobalParams::init_from_database(&db_pool).await` is called

### Then
- Method returns `Ok(())`
- All 15 parameters have values from database (not defaults)
- Values match database entries
- No warnings logged (all parameters found)

---

## Test Implementation

```rust
// File: wkmp-common/tests/params_integration.rs

use wkmp_common::params::PARAMS;
use sqlx::SqlitePool;

#[tokio::test]
async fn test_load_all_parameters_from_database() {
    // Setup: Create test database with all 15 parameters
    let db_pool = create_test_database_with_params().await;

    // Insert test values (different from defaults)
    insert_test_parameter(&db_pool, "volume_level", "real", None, None, Some(0.75)).await;
    insert_test_parameter(&db_pool, "working_sample_rate", "int", None, Some(48000), None).await;
    insert_test_parameter(&db_pool, "output_ringbuffer_size", "int", None, Some(96000), None).await;
    // ... (all 15 parameters)

    // Execute: Load from database
    let result = PARAMS.init_from_database(&db_pool).await;

    // Verify: Success
    assert!(result.is_ok(), "init_from_database should succeed");

    // Verify: Values loaded from database (not defaults)
    assert_eq!(*PARAMS.volume_level.read().unwrap(), 0.75);
    assert_eq!(*PARAMS.working_sample_rate.read().unwrap(), 48000);
    assert_eq!(*PARAMS.output_ringbuffer_size.read().unwrap(), 96000);
    // ... (verify all 15 parameters)

    // Cleanup
    cleanup_test_database(db_pool).await;
}

// Helper: Create test database
async fn create_test_database_with_params() -> SqlitePool {
    let db_pool = SqlitePool::connect(":memory:").await.unwrap();

    // Create settings table
    sqlx::query(
        r#"
        CREATE TABLE settings (
            key TEXT PRIMARY KEY NOT NULL,
            value_type TEXT NOT NULL,
            value_text TEXT,
            value_int INTEGER,
            value_real REAL
        )
        "#
    )
    .execute(&db_pool)
    .await
    .unwrap();

    db_pool
}

// Helper: Insert parameter
async fn insert_test_parameter(
    db_pool: &SqlitePool,
    key: &str,
    value_type: &str,
    value_text: Option<&str>,
    value_int: Option<i64>,
    value_real: Option<f64>,
) {
    sqlx::query(
        r#"
        INSERT INTO settings (key, value_type, value_text, value_int, value_real)
        VALUES (?, ?, ?, ?, ?)
        "#
    )
    .bind(key)
    .bind(value_type)
    .bind(value_text)
    .bind(value_int)
    .bind(value_real)
    .execute(db_pool)
    .await
    .unwrap();
}

// Helper: Cleanup
async fn cleanup_test_database(db_pool: SqlitePool) {
    db_pool.close().await;
}
```

---

## Verification Steps

### Automated Verification
```bash
cargo test --test params_integration test_load_all_parameters_from_database
```

### Expected Output
```
test test_load_all_parameters_from_database ... ok

test result: ok. 1 passed; 0 failed
```

---

## Pass Criteria

**Test PASSES if:**
- `init_from_database()` returns `Ok(())`
- All 15 parameters have values from database (verified by assertions)
- No panics or errors during execution
- Test completes in < 5 seconds

**Test FAILS if:**
- `init_from_database()` returns `Err(...)`
- Any parameter has default value (database value not loaded)
- Any assertion fails
- Timeout or panic

---

## Failure Handling

**If test fails:**
1. Check database connection successful
2. Verify settings table exists
3. Verify all 15 parameter keys inserted correctly
4. Check query logic in `init_from_database()` method
5. Verify type parsing (value_int, value_real) correct

**Common Issues:**
- Query fails: Check SQL syntax, table name
- Type mismatch: Verify value_int used for int types, value_real for float types
- Missing parameters: Check INSERT statements include all 15 keys

---

## Dependencies

**Test Depends On:**
- `wkmp-common/src/params.rs` with `init_from_database()` method implemented
- `sqlx` crate with SQLite support
- `tokio` async runtime

**Database Schema:**
```sql
CREATE TABLE settings (
    key TEXT PRIMARY KEY NOT NULL,
    value_type TEXT NOT NULL,
    value_text TEXT,
    value_int INTEGER,
    value_real REAL
);
```

---

## Test Data

**Test Parameter Values (Non-Default):**

| Parameter | Database Value | Default Value | Type |
|-----------|---------------|---------------|------|
| volume_level | 0.75 | 0.5 | real |
| working_sample_rate | 48000 | 44100 | int |
| output_ringbuffer_size | 96000 | 88200 | int |
| output_refill_period | 100 | 90 | int |
| maximum_decode_streams | 16 | 12 | int |
| decode_work_period | 6000 | 5000 | int |
| decode_chunk_size | 30000 | 25000 | int |
| playout_ringbuffer_size | 700000 | 661941 | int |
| playout_ringbuffer_headroom | 5000 | 4410 | int |
| decoder_resume_hysteresis_samples | 50000 | 44100 | int |
| mixer_min_start_level | 25000 | 22050 | int |
| pause_decay_factor | 0.90 | 0.95 | real |
| pause_decay_floor | 0.0002 | 0.0001778 | real |
| audio_buffer_size | 4096 | 2208 | int |
| mixer_check_interval_ms | 15 | 10 | int |

**Rationale:** Use non-default values to verify database loading actually occurred

---

## Traceability

**Requirements Verified:**
- FR-004: Database Synchronization (primary - loads from settings table)

**Related Tests:**
- TC-I-004-02: Handle missing database entries
- TC-I-004-03: Handle invalid type in database
- TC-I-004-04: Handle out-of-range values

---

## Notes

- Uses in-memory SQLite database (`:memory:`) for isolation
- Test data intentionally different from defaults to verify loading
- Helper functions reduce boilerplate in test body
- Test is idempotent (can run multiple times)

---

**Test Status:** Ready for Implementation
**Created:** 2025-11-02
**Last Updated:** 2025-11-02
