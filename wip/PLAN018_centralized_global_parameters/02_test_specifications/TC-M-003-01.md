# Test Specification: TC-M-003-01

## Test Metadata

| Field | Value |
|-------|-------|
| **Test ID** | TC-M-003-01 |
| **Test Type** | Manual Test |
| **Requirement** | FR-003 (No Hardcoded Values) |
| **Priority** | CRITICAL |
| **Estimated Effort** | 15 minutes per parameter |

---

## Test Description

**Objective:** Manually verify that no hardcoded parameter values remain in production code after migration

**Scope:** All Rust source files in wkmp-ap, wkmp-ui, wkmp-pd, wkmp-ai, wkmp-le, wkmp-dr, wkmp-common

**Rationale:** Automated grep (TC-U-003-01) may miss variations or false positives. Manual review provides additional confidence for CRITICAL requirement.

---

## Test Procedure

### Step 1: Automated Grep (Baseline)

Run automated search for hardcoded values:

```bash
# Search for all 15 default values in production code
rg "44100" --type rust -g '!*test*.rs'   # working_sample_rate
rg "0\.5" --type rust -g '!*test*.rs'    # volume_level
rg "88200" --type rust -g '!*test*.rs'   # output_ringbuffer_size
rg "90" --type rust -g '!*test*.rs'      # output_refill_period
rg "12" --type rust -g '!*test*.rs'      # maximum_decode_streams
rg "5000" --type rust -g '!*test*.rs'    # decode_work_period
rg "25000" --type rust -g '!*test*.rs'   # decode_chunk_size
rg "661941" --type rust -g '!*test*.rs'  # playout_ringbuffer_size
rg "4410" --type rust -g '!*test*.rs'    # playout_ringbuffer_headroom
rg "22050" --type rust -g '!*test*.rs'   # mixer_min_start_level
rg "0\.95" --type rust -g '!*test*.rs'   # pause_decay_factor
rg "0\.0001778" --type rust -g '!*test*.rs' # pause_decay_floor
rg "2208" --type rust -g '!*test*.rs'    # audio_buffer_size
rg "10" --type rust -g '!*test*.rs'      # mixer_check_interval_ms
```

**Record:** Count of matches per parameter

### Step 2: Review Grep Results

For each match found:

⚠️ **CRITICAL:** Multiple parameters share default values:
- `44100`: working_sample_rate (DBD-PARAM-020) AND decoder_resume_hysteresis_samples (DBD-PARAM-085)
- `22050`: mixer_min_start_level (DBD-PARAM-088)
- `4410`: playout_ringbuffer_headroom (DBD-PARAM-080)

**For each match found, apply context verification:**

See **[../../migration_context_verification.md](../../migration_context_verification.md)** for complete decision tree.

**Classification (ENHANCED):**
1. **Read ±10 lines of context around match**
2. **Check for DBD-PARAM tag** - If present, use parameter matching tag
3. **Analyze variable semantics** - Variable name reveals parameter (e.g., `hysteresis` vs `sample_rate`)
4. **Understand calculation purpose** - Timing conversion vs buffer threshold logic
5. **Apply decision tree** - Systematically determine which parameter

**Action:**
- **Legitimate (Unrelated):** Document reason, no action
- **Test Code:** Verify test file excluded, no action
- **Correct Parameter Match:** Document reasoning, replace with correct PARAMS.parameter_name
- **WRONG Parameter Match:** **TEST FAILS** - Misidentified parameter (e.g., replaced hysteresis with sample_rate)
- **VIOLATION (Production Code):** **TEST FAILS** - Hardcoded value not replaced

**CRITICAL RULE:** Never bulk-replace all instances of a value without verifying each match's context.

### Step 3: Manual Code Review (High-Risk Files)

Manually inspect these files for any numeric literals matching parameter values:

**High-Priority Files:**
- `wkmp-ap/src/playback/mixer.rs` (uses sample_rate, mixer_*, pause_*)
- `wkmp-ap/src/audio_output/mod.rs` (uses audio_buffer_size, sample_rate)
- `wkmp-ap/src/playback/engine.rs` (uses multiple parameters)
- `wkmp-ap/src/decode/*.rs` (uses decoder_* parameters)

**Review Checklist for Each File:**
- [ ] No numeric literals matching parameter defaults
- [ ] All parameter accesses use `wkmp_common::params::PARAMS.*`
- [ ] No Arc<RwLock<ParamType>> fields in structs
- [ ] No local variables holding parameter values long-term

### Step 4: Verify PARAMS Access Pattern

Search for correct access pattern:

```bash
# Should find many matches (all parameter accesses)
rg "PARAMS\\.\\w+\\.read\\(\\)" --type rust
```

**Expected:** 100+ matches across wkmp-ap codebase

### Step 5: Verify No Arc<RwLock> Fields Remain

Search for old pattern (should find NONE):

```bash
# Search for Arc<RwLock<...>> field declarations
rg "Arc<RwLock<(u32|u64|usize|f32|f64)>>" --type rust -g '!*test*.rs'
```

**Expected:** Zero matches (or matches clearly unrelated to parameters)

### Step 6: Critical Timing Parameters (Extra Scrutiny)

For Tier 3 (high-risk) parameters, perform additional manual review:

**Parameters:**
- working_sample_rate (DBD-PARAM-020)
- audio_buffer_size (DBD-PARAM-110)
- mixer_check_interval_ms (DBD-PARAM-111)
- decode_chunk_size (DBD-PARAM-065)
- output_refill_period (DBD-PARAM-040)
- decoder_resume_hysteresis_samples (DBD-PARAM-085)

**Extra Checks:**
- [ ] No division by hardcoded sample rate (e.g., `/ 44100`)
- [ ] No multiplication by hardcoded rates (e.g., `* 44100`)
- [ ] All timing calculations use `PARAMS.working_sample_rate`
- [ ] Audio callback uses `PARAMS.audio_buffer_size`

### Step 7: Documentation Review

Verify doc comments and code comments:

**Acceptable Hardcoded Values in Comments:**
- Example values: "// e.g., 44100 Hz"
- Default documentation: "/// Default: 44100 Hz"
- Historical notes: "// Was hardcoded as 44100"

**Unacceptable:**
- Hardcoded values in calculations in comments suggesting incorrect code

---

## Pass Criteria

**Test PASSES if:**
- Automated grep finds ZERO hardcoded values in production code
- Manual review finds NO parameter-related numeric literals
- All parameter accesses use `PARAMS.*` pattern
- Zero Arc<RwLock> fields for parameters
- Timing-critical code verified correct

**Test FAILS if:**
- ANY hardcoded parameter value found in production code
- Arc<RwLock> fields remain for parameters
- Timing calculations use hardcoded rates
- Suspicious numeric literals in high-risk files

---

## Failure Handling

**If test fails:**
1. Document location of hardcoded value (file:line)
2. Identify which parameter is hardcoded
3. Replace with `*PARAMS.parameter_name.read().unwrap()`
4. Re-run full test suite (`cargo test --workspace`)
5. Re-run this manual test from Step 1

**CRITICAL:** Do NOT proceed to next parameter until this test passes.

---

## Reporting Format

### Test Report Template

```markdown
## TC-M-003-01 Manual Test Report

**Date:** YYYY-MM-DD
**Tested By:** [Name]
**Parameter:** [parameter_name] (DBD-PARAM-XXX)

### Step 1: Automated Grep
- Matches Found: [N]
- Classification: [N] legitimate, [N] test code, [N] violations

### Step 2: Violations
[If N > 0, list file:line for each violation]

### Step 3: Manual Code Review
- Files Reviewed: [N]
- Issues Found: [N]
- Details: [List issues or "NONE"]

### Step 4: PARAMS Access Pattern
- Matches Found: [N] (expected: 100+)

### Step 5: Arc<RwLock> Fields
- Matches Found: [N] (expected: 0)

### Step 6: Timing Parameters (if applicable)
- Extra Checks: [PASS / FAIL]
- Issues: [List or "NONE"]

### Step 7: Documentation Review
- Comments Acceptable: [YES / NO]
- Issues: [List or "NONE"]

### Result
- **Status:** [PASS / FAIL]
- **Violations:** [N]
- **Action Required:** [NONE / List fixes needed]
```

---

## Dependencies

**Tools Required:**
- ripgrep (`rg` command)
- Code editor for manual review
- Access to full WKMP source tree

**Knowledge Required:**
- Understanding of SPEC016 parameters
- Familiarity with wkmp-ap codebase
- Ability to distinguish parameter values from other numeric literals

---

## Test Data

**Parameter Default Values to Search:**

| Parameter | Default Value | Grep Pattern |
|-----------|---------------|--------------|
| volume_level | 0.5 | `rg "0\.5"` |
| working_sample_rate | 44100 | `rg "44100"` |
| output_ringbuffer_size | 88200 | `rg "88200"` |
| output_refill_period | 90 | `rg "90"` |
| maximum_decode_streams | 12 | `rg "12"` |
| decode_work_period | 5000 | `rg "5000"` |
| decode_chunk_size | 25000 | `rg "25000"` |
| playout_ringbuffer_size | 661941 | `rg "661941"` |
| playout_ringbuffer_headroom | 4410 | `rg "4410"` |
| decoder_resume_hysteresis_samples | 44100 | `rg "44100"` (same as sample_rate) |
| mixer_min_start_level | 22050 | `rg "22050"` |
| pause_decay_factor | 0.95 | `rg "0\.95"` |
| pause_decay_floor | 0.0001778 | `rg "0\.0001778"` |
| audio_buffer_size | 2208 | `rg "2208"` |
| mixer_check_interval_ms | 10 | `rg "10"` |

---

## Traceability

**Requirements Verified:**
- FR-003: No Hardcoded Values (primary - manual verification of CRITICAL requirement)

**Related Tests:**
- TC-U-003-01: Automated grep for hardcoded values (complementary)

---

## Notes

- This test is CRITICAL because timing bug (10% position error) was caused by hardcoded 44100
- Manual review required because automated grep may miss variations (0x AC44 hex, 44.1 kHz comments, etc.)
- Performed after EACH parameter migration (15 times total)
- For high-risk parameters (Tier 3), perform Step 6 extra scrutiny
- Document all exceptions (legitimate uses of numeric values matching defaults)

---

**Test Status:** Ready for Execution (per-parameter during migration)
**Created:** 2025-11-02
**Last Updated:** 2025-11-02
