# Test Specification: TC-INV-001-01

**Test ID:** TC-INV-001-01
**Test Type:** Investigation (Manual)
**Requirement:** REQ-MIX-001 - Determine Active Mixer
**Priority:** P0-Critical
**Estimated Effort:** 20-30 minutes

---

## Test Objective

Identify which mixer implementation is currently instantiated and used by PlaybackEngine in wkmp-ap.

---

## Test Scope

**Component Under Test:** PlaybackEngine mixer instantiation

**Files to Inspect:**
- `wkmp-ap/src/playback/playback_engine.rs` (primary)
- `wkmp-ap/src/playback/mod.rs` (module declarations)
- `wkmp-ap/src/lib.rs` (public API)
- `wkmp-ap/src/main.rs` (if standalone binary)

**Search Patterns:**
- `CrossfadeMixer::new()`
- `Mixer::new()`
- `use.*mixer`
- `mod mixer`

---

## Test Procedure

### Step 1: Search for Mixer Instantiation

**Action:**
```bash
cd wkmp-ap
grep -rn "CrossfadeMixer::new()" src/
grep -rn "Mixer::new()" src/
```

**Expected Findings:**
- ONE of the above patterns should be found
- Located in PlaybackEngine initialization code

### Step 2: Identify Source File

**Action:**
- Check grep results for file path
- Two possibilities:
  1. **Legacy mixer:** `use crate::playback::pipeline::mixer::CrossfadeMixer;`
  2. **Correct mixer:** `use crate::playback::mixer::Mixer;`

**Expected:**
- Clear import statement showing which mixer is used

### Step 3: Verify Mixer Methods Called

**Action:**
- Read PlaybackEngine code around mixer instantiation
- Identify mixer methods called:
  - `start_passage(passage_id, fade_in_curve, duration)` → Legacy mixer
  - `mix_single(buffer, output)` / `mix_crossfade(...)` → Correct mixer

**Expected:**
- Method signatures match one mixer's API

### Step 4: Check Module Declarations

**Action:**
```bash
cd wkmp-ap/src/playback
cat mod.rs | grep "mod mixer"
```

**Expected:**
- ONE of the following:
  - `pub mod mixer;` → Correct mixer (mixer.rs)
  - `pub mod pipeline;` + inside pipeline: `pub mod mixer;` → Legacy mixer (pipeline/mixer.rs)

---

## Pass Criteria

**Test passes if ALL of the following are true:**
1. ✅ Exactly ONE mixer implementation is instantiated in PlaybackEngine
2. ✅ Mixer source file clearly identified (file path + line number)
3. ✅ Mixer type determined:
   - **Legacy:** `wkmp-ap/src/playback/pipeline/mixer.rs` (CrossfadeMixer)
   - **Correct:** `wkmp-ap/src/playback/mixer.rs` (Mixer)
4. ✅ Mixer API usage consistent with identified mixer type

---

## Fail Criteria

**Test fails if ANY of the following are true:**
- ❌ Both mixers instantiated (ambiguous which is active)
- ❌ Neither mixer instantiated (no mixer found)
- ❌ Mixer instantiation found but source file ambiguous
- ❌ API usage doesn't match identified mixer (e.g., calls `start_passage()` on Mixer struct)

---

## Test Output

**Document Findings:**

```markdown
### TC-INV-001-01 Results

**Active Mixer:** [Legacy | Correct]
**Source File:** [path]
**Instantiation Location:** [file:line]

**Evidence:**
- Import statement: `use ...`
- Instantiation code: `let mixer = ...`
- Method calls observed: `mixer.start_passage(...)` OR `mixer.mix_single(...)`

**Conclusion:** [Legacy mixer is active | Correct mixer is active]

**Implications:**
- [If Legacy] REQ-MIX-002 Scenario A applies (migration needed)
- [If Correct] REQ-MIX-002 Scenario B applies (archive legacy mixer)
- [If Legacy] REQ-MIX-007/008/009 feature porting NOT needed (features already present)
- [If Correct] REQ-MIX-007/008/009 investigate if features present or missing
```

---

## Dependencies

**Prerequisites:**
- Access to wkmp-ap source code
- Grep or equivalent search tool

**No blocking dependencies** (can execute immediately)

---

## Notes

**Disambiguation:**
- Both mixers use similar naming (`CrossfadeMixer` vs. `Mixer`)
- File paths are distinctive:
  - Legacy: `playback/pipeline/mixer.rs`
  - Correct: `playback/mixer.rs`
- API signatures are distinctive:
  - Legacy: Accepts fade curves as parameters
  - Correct: Does NOT accept fade curves

**Next Steps:**
- After test complete, document findings in investigation report
- Use findings to determine REQ-MIX-002 scenario (A or B)
- Use findings to determine if REQ-MIX-007/008/009 apply

---

**Test Specification Complete**
**Date:** 2025-01-30
