# TC-S-001: Remove Currently Playing Passage (Empty Queue After)

**Test ID:** TC-S-001
**Type:** System Test (End-to-End)
**Requirements:** REQ-FIX-010, REQ-FIX-020, REQ-FIX-030, REQ-FIX-040
**Priority:** Critical

---

## Test Objective

Verify that removing the ONLY passage in the queue (currently playing) results in immediate playback stop and proper resource cleanup.

---

## Test Scenario

**Given:**
- wkmp-ap running
- Empty queue
- Test audio file A available

**When:**
1. Enqueue passage A
2. Wait for playback to start
3. Remove passage A

**Then:**
- Playback stops immediately
- Queue becomes empty
- Decoder chain released (file handle closed)
- Mixer state cleared
- No audio output

---

## Pass Criteria

1. ✓ Playback stops within 100ms of removal
2. ✓ Queue empty after removal
3. ✓ Playback state = "Stopped"
4. ✓ Decoder resources released (no file handle leak)
5. ✓ No audio output after removal
6. ✓ SSE events: QueueStateUpdate (empty), PlaybackStateChanged (Stopped)

---

## Fail Criteria

1. ✗ Audio continues playing after removal
2. ✗ File handle remains open (resource leak)
3. ✗ Mixer continues reading stale data
4. ✗ Server crashes or hangs

---

## Expected Internal Behavior

When DELETE request received:
1. `remove_from_queue()` handler called
2. `engine.remove_queue_entry(queue_entry_id_A)` called
3. Engine detects: removed entry IS current
4. Engine clears decoder chain:
   - Sends stop command to decoder worker
   - Decoder closes file, clears buffer
   - Chain assignment removed
5. Engine clears mixer:
   - Mixer stops reading from chain
   - Ring buffer flushed/cleared
   - Playback position reset
6. Engine updates queue (already empty)
7. Engine sets playback state = Stopped
8. SSE events emitted

---

## Notes

- Simplest scenario (one passage, remove it)
- Tests basic cleanup mechanism
- Foundation for more complex scenarios
