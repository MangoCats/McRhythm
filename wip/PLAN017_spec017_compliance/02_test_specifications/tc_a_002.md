# TC-A-002: File Duration Storage Consistency

**Test Type:** Acceptance Test
**Priority:** MEDIUM
**Automation:** Yes (end-to-end test)
**Requirements:** REQ-F-003, REQ-NF-003

---

## Objective

Verify that file duration migration to i64 ticks is complete and consistent across the entire system: database schema, Rust structs, import workflow, and queries.

---

## Preconditions

- Fresh database (deleted old wkmp.db, rebuilt from empty)
- wkmp-ai import workflow available
- Sample audio files with known durations

---

## Acceptance Criteria

From REQ-F-003 and REQ-NF-003:
1. ✅ Database schema uses `duration_ticks INTEGER` (not `duration REAL`)
2. ✅ Rust struct `AudioFile` has `duration_ticks: Option<i64>` field
3. ✅ Import converts seconds to ticks via `seconds_to_ticks()`
4. ✅ Breaking change documented (no backward compatibility with old databases)
5. ✅ Migration path documented (rebuild database instructions)

---

## Test Procedure

### Part 1: Schema Verification (Automated)

**Given:**
- Fresh database initialized with latest schema

**When:**
- Query database schema via `PRAGMA table_info(files)`

**Then:**
- `duration_ticks INTEGER` column exists
- Old `duration REAL` column does NOT exist

**Implementation:**
```rust
#[tokio::test]
async fn test_schema_migration_complete() {
    let db = create_fresh_database().await;

    // Query schema
    let columns = db.query_all(
        "PRAGMA table_info(files)",
        &[]
    ).await.unwrap();

    let column_names: Vec<String> = columns.iter()
        .map(|row| row.get::<String>("name"))
        .collect();

    // Verify new field exists
    assert!(
        column_names.contains(&"duration_ticks".to_string()),
        "duration_ticks INTEGER column must exist"
    );

    // Verify old field removed
    assert!(
        !column_names.contains(&"duration".to_string()),
        "Old duration REAL column must not exist (breaking change)"
    );

    // Verify column type
    let duration_ticks_row = columns.iter()
        .find(|row| row.get::<String>("name") == "duration_ticks")
        .unwrap();

    let column_type: String = duration_ticks_row.get("type");
    assert_eq!(column_type, "INTEGER", "duration_ticks must be INTEGER type");
}
```

---

### Part 2: End-to-End Import Test (Automated)

**Given:**
- Fresh database
- 5-second sample WAV file

**When:**
- Import file via wkmp-ai workflow
- Query database for file record

**Then:**
- `duration_ticks` field contains 141,120,000
- Value is i64 integer (not f64 float)
- Conversion to seconds yields 5.0

**Implementation:**
```rust
#[tokio::test]
async fn test_end_to_end_file_import() {
    let db = create_fresh_database().await;

    // Import 5-second file
    let sample_path = PathBuf::from("test_assets/5sec_sample.wav");
    let file_id = import_audio_file(&db, &sample_path).await.unwrap();

    // Query database
    let row = db.query_one(
        "SELECT duration_ticks FROM files WHERE id = ?",
        &[&file_id]
    ).await.unwrap();

    let duration_ticks: Option<i64> = row.get("duration_ticks");

    // Verify storage
    assert!(duration_ticks.is_some(), "Duration should not be NULL");
    assert_eq!(duration_ticks.unwrap(), 141_120_000, "5 seconds = 141,120,000 ticks");

    // Verify type (i64, not f64)
    let _: i64 = duration_ticks.unwrap();  // Compile-time type check
}
```

---

### Part 3: Breaking Change Documentation (Manual Review)

**Given:**
- Project documentation (REQ-NF-003, migration notes)

**When:**
- Reviewer reads migration documentation

**Then:**
- Breaking change clearly stated
- Database rebuild instructions provided
- Users informed of incompatibility

**Verification Checklist:**
```
[ ] SPEC_spec017_compliance_remediation.md documents breaking change
[ ] Migration instructions: "Delete wkmp.db, restart services, re-import files"
[ ] Warning: "Existing databases incompatible, no automated migration"
[ ] Release notes template includes breaking change notice
```

**Required Documentation Content:**
```markdown
## Breaking Change: File Duration Migration

**Impact:** Database schema incompatible with previous versions

**Migration Steps:**
1. Stop all WKMP services
2. Delete existing database: `rm ~/Music/wkmp.db` (or Windows equivalent)
3. Restart services (database auto-created with new schema)
4. Re-import all audio files via wkmp-ai

**No automated migration:** User must manually rebuild database.

**Rationale:** Consistency with passage timing representation (all timing uses ticks).
```

---

### Part 4: Struct Field Verification (Code Review)

**Given:**
- Source code: `wkmp-ai/src/db/files.rs` or `wkmp-common/src/models/file.rs`

**When:**
- Reviewer inspects `AudioFile` struct definition

**Then:**
- Field is `duration_ticks: Option<i64>` (not `duration: Option<f64>`)

**Verification:**
```rust
// Expected in AudioFile struct:
pub struct AudioFile {
    pub id: Uuid,
    pub path: PathBuf,
    pub duration_ticks: Option<i64>,  // ✅ Correct
    // ... other fields
}

// NOT:
// pub duration: Option<f64>,  // ❌ Old field, must not exist
```

---

## Pass Criteria

**PASS:** All four parts succeed:
- ✅ Part 1: Schema has `duration_ticks INTEGER`, no `duration REAL`
- ✅ Part 2: End-to-end import stores ticks correctly
- ✅ Part 3: Breaking change documented with migration instructions
- ✅ Part 4: Rust struct has `duration_ticks: Option<i64>` field

**FAIL:** Any part fails:
- ❌ Schema still has old `duration REAL` field
- ❌ Import stores f64 seconds instead of i64 ticks
- ❌ Breaking change not documented
- ❌ Struct field type incorrect

---

## Edge Cases Covered

- ✅ Fresh database (schema creation from scratch)
- ✅ Known duration file (5 seconds)
- ✅ Breaking change warning
- ✅ Type safety (i64 vs f64 verification)

---

## Traceability

| Requirement | Test Coverage | Status |
|-------------|---------------|--------|
| REQ-F-003 | TC-A-002 Part 1 (schema) | ✅ Verified |
| REQ-F-003 | TC-A-002 Part 2 (import) | ✅ Verified |
| REQ-F-003 | TC-A-002 Part 4 (struct) | ✅ Verified |
| REQ-NF-003 | TC-A-002 Part 3 (docs) | ✅ Verified |

---

## Rollback Plan

**If this test fails after deployment:**

1. **Immediate:** Revert to previous version (restore old schema)
2. **Short-term:** Restore old `duration REAL` field, deprecate but keep both
3. **Long-term:** Fix migration issues, retry breaking change in next release

**Prevention:** This test MUST pass before deployment to avoid rollback scenario.

---

## Notes

- This test verifies **system-wide consistency** (not just single component)
- Combines automated tests (schema, import) with manual review (docs, code)
- Breaking change acceptance test - ensures user migration path is clear
- End-to-end test scope: database schema → import workflow → storage → retrieval
