# TC-A-003: API Documentation Completeness

**Test Type:** Acceptance Test
**Priority:** MEDIUM
**Automation:** Manual (code review)
**Requirements:** REQ-F-002, REQ-NF-002

---

## Objective

Verify that all API timing fields are documented with explicit unit information, and SPEC017 is updated to document the pragmatic deviation from SRC-API-010 (APIs use milliseconds/seconds instead of raw ticks).

---

## Preconditions

- Source code accessible:
  - `wkmp-ap/src/api/handlers.rs`
  - `wkmp-ai/src/api/amplitude_analysis.rs`
- Documentation accessible:
  - `docs/SPEC017-sample_rate_conversion.md`
  - `docs/IMPL001-database_schema.md`

---

## Acceptance Criteria

From REQ-F-002 and REQ-NF-002:
1. ✅ Every API timing field has doc comment with unit
2. ✅ Function parameters use unit suffixes (`_ms`, `_seconds`)
3. ✅ SPEC017 updated with "API Layer Pragmatic Deviation" section
4. ✅ Error messages reference correct units

---

## Test Procedure

### Part 1: wkmp-ap API Documentation Review

**Given:**
- Source file: `wkmp-ap/src/api/handlers.rs`

**When:**
- Reviewer inspects API structs with timing fields

**Then:**
- Doc comments present and specify units

**Verification Checklist:**

```rust
// ✅ GOOD: Unit documented
/// Current playback position in milliseconds since passage start.
/// Unit: milliseconds (ms)
pub position_ms: u64,

// ✅ GOOD: Unit in field name and comment
/// Seek target position (milliseconds)
pub seek_position_ms: u64,

// ❌ BAD: Unit not documented
pub position: u64,  // What unit? Ticks? ms? seconds?
```

**Specific structs to check:**
- `PositionResponse` - should have `position_ms: u64` with doc comment
- `SeekRequest` - should have `seek_position_ms: u64` with doc comment

---

### Part 2: wkmp-ai API Documentation Review

**Given:**
- Source file: `wkmp-ai/src/api/amplitude_analysis.rs`

**When:**
- Reviewer inspects API structs with timing fields

**Then:**
- Doc comments present and specify units

**Verification Checklist:**

```rust
// ✅ GOOD: Unit documented
/// Start time for amplitude analysis in seconds.
/// Unit: seconds (f64)
pub start_time_seconds: f64,

// ✅ GOOD: Unit in field name and comment
/// Analysis window duration (seconds)
pub duration_seconds: f64,

// ❌ BAD: Unit not documented
pub start_time: f64,  // Ambiguous
```

**Specific structs to check:**
- `AmplitudeAnalysisRequest` - timing fields documented
- `AmplitudeAnalysisResponse` - timing fields documented

---

### Part 3: SPEC017 Update Verification

**Given:**
- File: `docs/SPEC017-sample_rate_conversion.md`

**When:**
- Reviewer searches for "API Layer Pragmatic Deviation" section

**Then:**
- Section exists and documents deviation from SRC-API-010

**Required Section Content (from SPEC_spec017_compliance_remediation.md lines 367-391):**

```markdown
## API Layer Pragmatic Deviation

**Deviation from SRC-API-010:** WKMP HTTP APIs use milliseconds and seconds
instead of raw ticks for ergonomic reasons.

**Rationale:** External API consumers (web UI, third-party clients) benefit
from familiar time units (ms/seconds) over tick-based representation.

**Requirements:**
- All API timing fields MUST include unit in field name (`_ms`, `_seconds`)
- All API timing fields MUST have doc comments specifying unit
- Conversions to/from ticks MUST use wkmp_common::timing functions
- Error messages MUST reference correct units

**Affected APIs:**
- wkmp-ap playback position: milliseconds (u64)
- wkmp-ai amplitude analysis: seconds (f64)

**Internal Consistency:** Database and core engine remain tick-based per SRC-DB-011.
```

**Verification:**
```
[ ] Section titled "API Layer Pragmatic Deviation" exists
[ ] Rationale provided (ergonomics for external consumers)
[ ] Requirements list included (unit suffixes, doc comments, conversions)
[ ] Affected APIs enumerated (wkmp-ap, wkmp-ai)
[ ] Internal consistency note (database remains tick-based)
```

---

### Part 4: Error Message Unit Clarity

**Given:**
- API error handling code in wkmp-ap, wkmp-ai

**When:**
- Reviewer inspects error messages related to timing

**Then:**
- Error messages reference correct units

**Examples:**

```rust
// ✅ GOOD: Unit specified in error
return Err(ApiError::InvalidParameter(
    format!("seek_position_ms must be >= 0, got {}", seek_position_ms)
));

// ✅ GOOD: Unit clear from context
return Err(ApiError::OutOfRange(
    format!("Position {} ms exceeds passage duration {} ms", pos_ms, duration_ms)
));

// ❌ BAD: Unit ambiguous
return Err(ApiError::InvalidParameter(
    format!("Invalid position: {}", position)  // What unit?
));
```

**Verification:**
```
[ ] Error messages use unit suffixes in variable names
[ ] Error messages specify unit in text if ambiguous
[ ] No error messages with bare "time" or "position" without unit
```

---

### Part 5: IMPL001 Database Schema Update

**Given:**
- File: `docs/IMPL001-database_schema.md`

**When:**
- Reviewer locates "files" table definition

**Then:**
- `duration_ticks INTEGER` documented (not `duration REAL`)

**Verification:**
```
[ ] Files table section exists
[ ] duration_ticks INTEGER field documented
[ ] Old duration REAL field NOT documented
[ ] Comment references SPEC017
```

**Expected Documentation:**
```markdown
### files Table

| Column | Type | Description |
|--------|------|-------------|
| id | TEXT PRIMARY KEY | UUID |
| path | TEXT NOT NULL | File path |
| duration_ticks | INTEGER | Duration in ticks per SPEC017 (nullable if unknown) |
| ... | ... | ... |
```

---

## Pass Criteria

**PASS:** All five parts succeed:
- ✅ Part 1: wkmp-ap API fields documented with units
- ✅ Part 2: wkmp-ai API fields documented with units
- ✅ Part 3: SPEC017 has "API Layer Pragmatic Deviation" section
- ✅ Part 4: Error messages reference correct units
- ✅ Part 5: IMPL001 documents `duration_ticks INTEGER`

**FAIL:** Any part fails:
- ❌ Any API timing field lacks doc comment or unit suffix
- ❌ SPEC017 missing deviation section
- ❌ Error messages ambiguous about units
- ❌ IMPL001 still documents old `duration REAL`

---

## Documentation Checklist

**API Files:**
```
[ ] wkmp-ap/src/api/handlers.rs - PositionResponse documented
[ ] wkmp-ap/src/api/handlers.rs - SeekRequest documented
[ ] wkmp-ai/src/api/amplitude_analysis.rs - AmplitudeAnalysisRequest documented
[ ] wkmp-ai/src/api/amplitude_analysis.rs - AmplitudeAnalysisResponse documented
```

**Documentation Files:**
```
[ ] docs/SPEC017-sample_rate_conversion.md - Pragmatic deviation section added
[ ] docs/IMPL001-database_schema.md - duration_ticks INTEGER documented
```

---

## Traceability

| Requirement | Test Coverage | Status |
|-------------|---------------|--------|
| REQ-F-002 | TC-A-003 Part 1 (wkmp-ap) | ✅ Verified |
| REQ-F-002 | TC-A-003 Part 2 (wkmp-ai) | ✅ Verified |
| REQ-F-002 | TC-A-003 Part 3 (SPEC017) | ✅ Verified |
| REQ-F-002 | TC-A-003 Part 4 (errors) | ✅ Verified |
| REQ-NF-002 | TC-A-003 Part 5 (IMPL001) | ✅ Verified |

---

## Evidence Collection

**For audit trail:**
1. **Git Diff:** Changes to wkmp-ap/src/api/handlers.rs showing doc comments
2. **Git Diff:** Changes to SPEC017 showing new section
3. **Screenshot:** SPEC017 "API Layer Pragmatic Deviation" section
4. **Checklist:** Completed verification checklist (this document, filled out)

---

## Notes

- This is a **manual code review test** (not automated)
- Requires domain knowledge to assess documentation quality
- Can be re-run after any API changes (regression verification)
- Documentation completeness is subjective - use provided examples as standard
- Primary goal: Prevent future confusion about timing units in APIs
