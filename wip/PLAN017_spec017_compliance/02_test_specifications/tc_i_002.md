# TC-I-002: wkmp-dr Display Rendering

**Test Type:** Integration Test
**Priority:** HIGH
**Automation:** Partial (requires browser automation or manual verification)
**Requirements:** REQ-F-001

---

## Objective

Verify that wkmp-dr's passages table displays timing columns in dual format: `{ticks} ({seconds}s)` with 6 decimal places for seconds.

---

## Preconditions

- wkmp-dr running on http://localhost:5725
- Database populated with at least one passage containing timing values
- Browser available for inspection

---

## Test Data

**Sample Passage Record:**
```sql
INSERT INTO passages (id, file_id, start_time_ticks, end_time_ticks,
                      fade_in_start_ticks, fade_out_start_ticks,
                      lead_in_start_ticks, lead_out_start_ticks)
VALUES (
    '12345678-1234-1234-1234-123456789abc',
    'file-uuid',
    0,              -- start_time_ticks
    141120000,      -- end_time_ticks (5.000000s)
    14112000,       -- fade_in_start_ticks (0.500000s)
    126000000,      -- fade_out_start_ticks (4.466102s)
    28224000,       -- lead_in_start_ticks (1.000000s)
    112896000       -- lead_out_start_ticks (4.000000s)
);
```

**Expected Display Format:**

| Column | Expected Cell Content |
|--------|----------------------|
| start_time_ticks | `0 (0.000000s)` |
| end_time_ticks | `141120000 (5.000000s)` |
| fade_in_start_ticks | `14112000 (0.500000s)` |
| fade_out_start_ticks | `126000000 (4.466102s)` |
| lead_in_start_ticks | `28224000 (1.000000s)` |
| lead_out_start_ticks | `112896000 (4.000000s)` |

---

## Test Procedure

### Given
- wkmp-dr server running
- Database contains sample passage record (as above)
- Browser navigated to http://localhost:5725

### When
- User selects "passages" table in wkmp-dr UI
- Table renders with all columns visible

### Then
- All 6 timing columns display dual format
- Format matches regex: `^\d+ \(\d+\.\d{6}s\)$`
- Seconds values are mathematically correct (ticks / 28224000)
- NULL values display as `null` (no conversion attempted)

---

## Automated Test Implementation

```javascript
// Browser automation test (Playwright/Puppeteer example)
const { test, expect } = require('@playwright/test');

test('wkmp-dr displays dual time format', async ({ page }) => {
    // Navigate to wkmp-dr
    await page.goto('http://localhost:5725');

    // Select passages table
    await page.click('button:has-text("passages")');

    // Wait for table to render
    await page.waitForSelector('table');

    // Verify timing column format
    const startTimeCell = await page.locator('td:has-text("start_time_ticks")').first();
    const cellText = await startTimeCell.textContent();

    // Regex: digits, space, parenthesis, digits.6decimals, s, close parenthesis
    const dualFormatRegex = /^\d+ \(\d+\.\d{6}s\)$/;
    expect(cellText).toMatch(dualFormatRegex);

    // Verify specific values
    const endTimeCell = await page.locator('td:has-text("141120000")').first();
    const endTimeText = await endTimeCell.textContent();
    expect(endTimeText).toBe('141120000 (5.000000s)');

    // Verify NULL handling
    const nullCell = await page.locator('td:has-text("null")').first();
    const nullText = await nullCell.textContent();
    expect(nullText).toBe('null');  // No conversion for NULL
});
```

---

## Manual Test Procedure

**If automated browser testing unavailable:**

1. **Setup:**
   - Start wkmp-dr: `cargo run -p wkmp-dr`
   - Open browser: http://localhost:5725
   - Ensure database has passages table with timing data

2. **Execution:**
   - Click "passages" in table selector
   - Locate any row with non-NULL timing values

3. **Verification:**
   - For `end_time_ticks` column:
     - Should display: `141120000 (5.000000s)` format
     - NOT: `141120000` alone
     - NOT: `5.000000s` alone
   - For all 6 timing columns (start_time_ticks, end_time_ticks, fade_in_start_ticks, fade_out_start_ticks, lead_in_start_ticks, lead_out_start_ticks):
     - Should display dual format
   - For NULL values:
     - Should display: `null`
     - NOT: `null (NaNs)` or error

4. **Manual Calculation Verification:**
   - Pick any tick value displayed (e.g., 141120000)
   - Calculate: 141120000 / 28224000 = 5.000000
   - Verify displayed seconds match calculation

---

## Pass Criteria

**Automated:**
- Regex matches dual format for all timing columns
- Specific value checks pass (141120000 = 5.000000s)
- NULL values display correctly (no conversion)

**Manual:**
- Visual inspection confirms dual format in all 6 timing columns
- Manual calculation matches displayed seconds
- NULL values display as `null`

**FAIL:**
- Any timing column displays ticks only
- Any timing column displays seconds only
- Seconds calculation incorrect
- NULL values cause errors or display incorrectly

---

## Edge Cases Covered

- ✅ Zero ticks (0 = 0.000000s)
- ✅ Large tick values (141120000 = 5.000000s)
- ✅ Fractional seconds (14112000 = 0.500000s)
- ✅ NULL values (no conversion, display "null")

---

## Dependencies

- wkmp-dr running instance
- Database with passages table and timing data
- Browser (Chrome, Firefox, Edge) for manual test
- Playwright/Puppeteer for automated test (optional)

---

## Regression Risk

**Low:** Display change only, no data modification
- If test fails, worst case: UI displays incorrectly (no data corruption)
- Can be fixed with JavaScript patch, no database changes needed

---

## Notes

- This is an **integration test** (requires running server + database)
- Automated variant requires browser automation framework
- Manual variant is acceptable for single implementation verification
- Consider screenshot comparison for visual regression testing
- Timing column list: `['start_time_ticks', 'end_time_ticks', 'fade_in_start_ticks', 'fade_out_start_ticks', 'lead_in_start_ticks', 'lead_out_start_ticks']`
