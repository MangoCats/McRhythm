# Test Specification: TC-I-030-02 - Test Suite Pass Rate

**Test ID:** TC-I-030-02
**Requirement:** REQ-DEBT-QUALITY-002-030 (API Stability)
**Type:** Integration Test
**Scope:** Existing test suite
**Estimated Effort:** 10 minutes to implement (test already exists)

---

## Test Objective

Verify that ALL existing tests continue to pass after refactoring, demonstrating that the public API and behavior have not changed.

---

## Test Specification

**Given:** Refactoring has been completed

**When:** Full test suite is executed

**Then:** 100% of baseline tests pass (same pass/fail status as before refactoring)

---

## Baseline Establishment (Pre-Refactoring)

**Step 1:** Run test suite BEFORE refactoring
```bash
cargo test -p wkmp-ap 2>&1 | tee baseline_tests.log
```

**Step 2:** Extract baseline metrics
- Total tests run
- Tests passed
- Tests failed
- Tests ignored

**Example Baseline:**
```
test result: ok. 156 passed; 0 failed; 12 ignored; 0 measured; 0 filtered out
```

**Step 3:** Document baseline
```bash
echo "Baseline: 156 passed, 0 failed, 12 ignored" > test_baseline.txt
```

---

## Verification Steps (Post-Refactoring)

**Step 1:** Run test suite AFTER refactoring
```bash
cargo test -p wkmp-ap 2>&1 | tee refactored_tests.log
```

**Step 2:** Compare results to baseline
- Passed count should match baseline (156)
- Failed count should match baseline (0)
- Ignored count may differ (acceptable if documented)

**Step 3:** Verify no new test failures
```bash
diff <(grep "test result" baseline_tests.log) <(grep "test result" refactored_tests.log)
```
**Expected:** No differences in pass/fail counts

---

## Automated Test Implementation

**Bash Script:**

```bash
#!/bin/bash
# tc_i_030_02_test_suite_pass_rate.sh

echo "TC-I-030-02: Test Suite Pass Rate"

# Check baseline exists
if [ ! -f test_baseline.txt ]; then
    echo "ERROR: Baseline not established. Run cargo test before refactoring."
    exit 2
fi

# Run tests
cargo test -p wkmp-ap --quiet 2>&1 | tee refactored_tests.log

# Extract pass/fail counts
PASSED=$(grep -oP '\d+(?= passed)' refactored_tests.log | head -1)
FAILED=$(grep -oP '\d+(?= failed)' refactored_tests.log | head -1)

# Load baseline
BASELINE_PASSED=$(grep -oP '\d+(?= passed)' test_baseline.txt)
BASELINE_FAILED=$(grep -oP '\d+(?= failed)' test_baseline.txt)

echo "Baseline: $BASELINE_PASSED passed, $BASELINE_FAILED failed"
echo "Current:  $PASSED passed, $FAILED failed"

# Compare
if [ "$PASSED" -eq "$BASELINE_PASSED" ] && [ "$FAILED" -eq "$BASELINE_FAILED" ]; then
    echo "PASS: Test results match baseline"
    exit 0
else
    echo "FAIL: Test results differ from baseline"
    exit 1
fi
```

---

## Pass Criteria

✅ **Pass If:**
- Passed test count == baseline passed count
- Failed test count == baseline failed count
- No new test failures introduced
- Exit code 0

❌ **Fail If:**
- Fewer tests pass than baseline
- More tests fail than baseline
- New test failures detected
- Exit code non-zero

---

## Fail Criteria Details

**Failure Mode 1: Tests fail to compile**
- Symptom: `cargo test` compilation errors
- Likely Cause: API changed (broke public interface)
- Action: Revert refactoring, fix API breakage

**Failure Mode 2: Tests compile but fail at runtime**
- Symptom: Test execution failures (not present in baseline)
- Likely Cause: Behavior changed during refactoring
- Action: Debug failing tests, fix logic errors

**Failure Mode 3: Fewer tests run than baseline**
- Symptom: Test count decreased (e.g., 150 vs. 156)
- Likely Cause: Test files not found, test modules broken
- Action: Verify all test files present, check module structure

---

## Detailed Failure Analysis

If tests fail, use detailed output for diagnosis:

```bash
# Run with full output
cargo test -p wkmp-ap -- --nocapture

# Run specific failing test
cargo test -p wkmp-ap test_enqueue_passage -- --nocapture

# Show backtrace
RUST_BACKTRACE=1 cargo test -p wkmp-ap test_enqueue_passage
```

---

## Test Categories to Verify

**Expected Test Categories (from wkmp-ap/tests/):**

1. **Unit Tests:**
   - Mixer tests (42 tests) - Should be unaffected
   - Buffer tests - Should be unaffected
   - Queue tests - Should be unaffected

2. **Integration Tests:**
   - Playback engine tests - **Critical** (exercises refactored code)
   - Decoder pool tests - May be affected if engine API changed
   - Comprehensive playback tests - **Critical**

3. **API Tests:**
   - HTTP handler tests - **Critical** (verifies handler→engine contract)

---

## Acceptable Deviations

**Ignored Tests:**
- Baseline: 12 ignored
- Post-refactoring: May differ
- Reason: Ignored tests often depend on external resources (files, network)
- Action: Document change, verify expected

**Flaky Tests:**
- If baseline had flaky tests (pass sometimes), document known flakes
- Post-refactoring flakiness should match baseline
- New flakiness = potential issue

---

## Test Data

**Baseline File:** `test_baseline.txt` (created pre-refactoring)

**Example Content:**
```
Baseline: 156 passed; 0 failed; 12 ignored; 0 measured; 0 filtered out
Date: 2025-11-01
Branch: feature/plan016-engine-refactoring
Commit: a1b2c3d4
```

---

## Dependencies

**Prerequisites:**
- Baseline established (run tests before refactoring)
- Refactoring implementation completed
- wkmp-ap crate compiles

**External Dependencies:**
- cargo test (Rust toolchain)
- Test suite in wkmp-ap/tests/

---

## Execution Context

**When to Run:**
- BEFORE refactoring (establish baseline)
- AFTER each major refactoring step
- AFTER final refactoring completion
- As part of CI/CD pipeline
- Before code review/merge

**Execution Time:** ~30-120 seconds (depends on test count)

---

## Reporting

**Summary Output Format:**

```
TC-I-030-02: Test Suite Pass Rate
====================================
Baseline: 156 passed, 0 failed, 12 ignored
Current:  156 passed, 0 failed, 12 ignored

Difference: None

Result: PASS ✓
```

**On Failure:**

```
TC-I-030-02: Test Suite Pass Rate
====================================
Baseline: 156 passed, 0 failed, 12 ignored
Current:  152 passed, 4 failed, 12 ignored

Difference: -4 passed, +4 failed

Failed Tests:
- test_enqueue_passage_api
- test_skip_current_during_playback
- test_get_status_while_playing
- test_pause_resume_cycle

Result: FAIL ✗

Action: Review failed tests for API breakage
```

---

## Traceability

**Requirement:** REQ-DEBT-QUALITY-002-030 (Public API SHALL remain unchanged)
**Acceptance Criterion:** "All existing tests pass without modification"
**Related Tests:**
- TC-U-030-01 (Public API surface check)
- TC-I-030-01 (Handler compilation)
- TC-S-030-01 (API compatibility verification)

---

**Test Specification Complete**
**Status:** Ready for implementation
