# Test Specification: TC-U-020-01 - Line Count Measurement

**Test ID:** TC-U-020-01
**Requirement:** REQ-DEBT-QUALITY-002-020 (Line Count Limit)
**Type:** Unit Test
**Scope:** File metrics
**Estimated Effort:** 5 minutes to write + implement

---

## Test Objective

Verify that each refactored module file is less than 1500 lines, satisfying the line count constraint.

---

## Test Specification

**Given:** Refactoring has been completed

**When:** Line counts are measured for each module file

**Then:** Each file has fewer than 1500 lines

---

## Verification Steps

**Step 1:** Count lines in mod.rs
```bash
wc -l wkmp-ap/src/playback/engine/mod.rs
```
**Expected:** < 1500 lines

**Step 2:** Count lines in core.rs
```bash
wc -l wkmp-ap/src/playback/engine/core.rs
```
**Expected:** < 1500 lines

**Step 3:** Count lines in queue.rs
```bash
wc -l wkmp-ap/src/playback/engine/queue.rs
```
**Expected:** < 1500 lines

**Step 4:** Count lines in diagnostics.rs
```bash
wc -l wkmp-ap/src/playback/engine/diagnostics.rs
```
**Expected:** < 1500 lines

---

## Automated Test Implementation

**Bash Script:**

```bash
#!/bin/bash
# tc_u_020_01_line_count.sh

cd wkmp-ap/src/playback/engine

echo "TC-U-020-01: Line Count Measurement"

LINE_LIMIT=1500
FAIL=0

for file in mod.rs core.rs queue.rs diagnostics.rs; do
    if [ ! -f "$file" ]; then
        echo "FAIL: File $file does not exist"
        FAIL=1
        continue
    fi

    lines=$(wc -l < "$file")
    if [ "$lines" -ge "$LINE_LIMIT" ]; then
        echo "FAIL: $file has $lines lines (limit: <$LINE_LIMIT)"
        FAIL=1
    else
        echo "PASS: $file has $lines lines (<$LINE_LIMIT)"
    fi
done

if [ $FAIL -eq 0 ]; then
    echo "✓ All modules under line limit"
    exit 0
else
    echo "✗ One or more modules exceed line limit"
    exit 1
fi
```

**Alternative: Rust Build Script (build.rs)**

```rust
// build.rs - Runs at compile time

use std::fs;
use std::path::Path;

fn main() {
    let engine_path = Path::new("src/playback/engine");
    let line_limit = 1500;
    let mut failures = Vec::new();

    for file in &["mod.rs", "core.rs", "queue.rs", "diagnostics.rs"] {
        let path = engine_path.join(file);
        if let Ok(content) = fs::read_to_string(&path) {
            let line_count = content.lines().count();
            if line_count >= line_limit {
                failures.push(format!("{} has {} lines (limit: {})", file, line_count, line_limit));
            } else {
                println!("cargo:warning={} has {} lines (<{})", file, line_count, line_limit);
            }
        }
    }

    if !failures.is_empty() {
        panic!("Line count limit exceeded:\n{}", failures.join("\n"));
    }
}
```

---

## Pass Criteria

✅ **Pass If:**
- mod.rs < 1500 lines
- core.rs < 1500 lines
- queue.rs < 1500 lines
- diagnostics.rs < 1500 lines
- Exit code 0

❌ **Fail If:**
- ANY file ≥ 1500 lines
- Exit code non-zero

---

## Fail Criteria Details

**Failure Mode 1: Module exceeds limit**
- Symptom: File has ≥1500 lines
- Likely Cause: Uneven code distribution during refactoring
- Action: Further decompose the oversized module
- Example: Split core.rs → core.rs + core_state.rs + core_lifecycle.rs

**Failure Mode 2: mod.rs too large**
- Symptom: mod.rs ≥1500 lines
- Likely Cause: Too much code in interface module (should be mostly re-exports)
- Action: Move implementation code to core.rs or other modules

---

## Boundary Conditions

**Edge Case 1: Exactly 1499 lines**
- Result: PASS (< 1500)
- Note: Technically compliant, but risky (no headroom for small additions)
- Recommendation: Keep modules well under limit (target ~1200 lines)

**Edge Case 2: Empty file (0 lines)**
- Result: PASS (< 1500)
- Note: Likely indicates incomplete refactoring
- Cross-check: Verify file has expected content

---

## Test Data

**Baseline Measurement (Pre-Refactoring):**

Before refactoring, record original line count:
```bash
wc -l wkmp-ap/src/playback/engine.rs
```
**Expected Baseline:** ~4,251 lines (as of 2025-11-01)

**Purpose:** Compare total lines before/after to detect code bloat or loss

---

## Dependencies

**Prerequisites:**
- All module files exist (verified by TC-U-010-01)
- Refactoring implementation completed

**Tools Required:**
- `wc` command (standard on Unix/Linux/macOS/Git Bash)

---

## Execution Context

**When to Run:**
- After code migration to each module
- After final refactoring completion
- As part of CI/CD pipeline (enforce limit)
- Before code review/merge

**Execution Time:** <2 seconds

---

## Reporting

**Summary Output Format:**

```
TC-U-020-01: Line Count Measurement
====================================
mod.rs:         87 lines (<1500) ✓
core.rs:       1423 lines (<1500) ✓
queue.rs:       945 lines (<1500) ✓
diagnostics.rs: 782 lines (<1500) ✓

Total: 3237 lines (Original: 4251 lines)

Result: PASS
```

---

## Traceability

**Requirement:** REQ-DEBT-QUALITY-002-020
**Acceptance Criterion:** "Each refactored module SHALL be <1500 lines"
**Related Tests:** TC-S-020-01 (total line preservation)

---

**Test Specification Complete**
**Status:** Ready for implementation
