# TC-M-DC-010-01: Pre-Implementation Dead Code Detection

**Test ID:** TC-M-DC-010-01
**Test Type:** Manual Test
**Requirement:** REQ-DC-010 (Pre-Implementation Dead Code Removal)
**Priority:** P0 (Critical)
**Created:** 2025-01-15

---

## Purpose

Identify and remove all dead code in wkmp-ai BEFORE implementing batch writes optimization.

**Resolves:** ISSUE-002 (Dead code detection method unclear)

---

## Test Specification

### Scope

**Component Under Test:** Entire wkmp-ai codebase
**Files Involved:** wkmp-ai/src/**/*.rs (all Rust source files)

### Test Procedure

#### Step 1: Run cargo clippy (Primary Detection)

**Command:**
```bash
cd wkmp-ai
cargo clippy --all-targets --all-features -- -W unused
```

**Expected Output Format:**
```
warning: unused import: `X`
warning: function `foo` is never used
warning: associated function `bar` is never used
warning: variant `Baz` is never constructed
```

**Action:** Record all "unused" warnings to file: `dead_code_report_pre.txt`

**Pass Criteria:** Command executes successfully, warnings recorded

---

#### Step 2: Run cargo build (Secondary Detection)

**Command:**
```bash
cargo build --all-targets --all-features
```

**Expected Output Format:**
```
warning: unused variable: `x`
warning: unused import: `Y`
```

**Action:** Record warnings not already captured by clippy

**Pass Criteria:** Build succeeds (warnings OK, errors = FAIL)

---

#### Step 3: Manual Review for Logic Dead Code

**Procedure:**
1. Search for code paths that can never execute:
   - `if false { ... }`
   - Unreachable match arms
   - Functions behind `#[cfg(...)]` that never activate

2. Search for experimental/incomplete code:
   - TODO comments with unused functions
   - Commented-out function definitions
   - Test-only code not marked `#[cfg(test)]`

3. Search for obsolete code:
   - Old implementations replaced but not removed
   - Backup functions no longer used

4. **Search for test-support code unused by application** (CRITICAL):
   - Helper functions/fixtures in src/ only called from tests
   - Mock implementations not used by live application
   - Test utilities that should be in tests/ not src/
   - Database setup functions only used in test code

**Tools:**
```bash
# Search for suspicious patterns
rg "if false" wkmp-ai/src
rg "TODO.*unused" wkmp-ai/src
rg "#\[allow\(dead_code\)\]" wkmp-ai/src

# Find test-support code (functions only called from #[cfg(test)])
rg "#\[cfg\(test\)\]" wkmp-ai/src -A 20  # Review what's in test modules
rg "pub.*test.*helper" wkmp-ai/src     # Common test helper naming
rg "pub.*mock" wkmp-ai/src              # Mock implementations
```

**Action:** Add findings to `dead_code_report_pre.txt`

**Important:** Test-support code in src/ that is ONLY used by tests is dead code and should be removed. Tests will be refactored to not depend on this code, or code will be moved to tests/ directory if genuinely needed.

---

#### Step 4: Categorize Dead Code

For each dead code item found, categorize:

**Category 1: Safe to Remove** ✅
- Unused helper functions with no #[allow]
- Unused imports
- Unused struct fields (if struct is unused)
- Unreferenced modules
- **Test-support code in src/ only used by tests** (tests will be refactored)

**Category 2: Review Before Removal** ⚠️
- Public API functions (may be used externally - check for external usage)
- Code marked #[allow(dead_code)] (intentional retention - verify rationale still valid)
- Code behind feature flags (may be used in other builds - check Full vs Lite)
- Code that looks like test utilities but might be used by application (verify usage)

**Category 3: Do Not Remove** ❌
- Code required by external tools (not detected by compiler)
- Public trait implementations (required by trait)
- Code used via macros (compiler may miss usage)
- **NOT test utilities** - test utilities in src/ should be in Category 1 or moved to tests/

**Output Format:**
```
# dead_code_report_pre.txt

## Category 1: Safe to Remove (N items)
- [ ] wkmp-ai/src/foo.rs:45 - unused function `bar`
- [ ] wkmp-ai/src/baz.rs:12 - unused import `qux`

## Category 2: Review Before Removal (N items)
- [ ] wkmp-ai/src/pub_api.rs:67 - unused pub fn (check external usage)

## Category 3: Do Not Remove (N items)
- wkmp-ai/src/traits.rs:23 - #[allow(dead_code)] Default impl for Foo
  Reason: Required by trait, but not called directly
```

---

#### Step 5: Remove Category 1 Dead Code

**For each item in Category 1:**

1. **Create git branch:**
   ```bash
   git checkout -b dead-code-removal-pre
   ```

2. **Remove code incrementally:**
   - One file at a time (easier to revert)
   - Run tests after each file

3. **After each removal:**
   ```bash
   cargo test --all-targets
   ```

4. **If tests PASS:** ✅ Commit removal
   ```bash
   git add wkmp-ai/src/modified_file.rs
   git commit -m "Remove unused function `bar` from foo.rs"
   ```

5. **If tests FAIL due to test dependency:** ❌ Refactor tests, then remove code
   ```bash
   # Option A: Refactor test to not need the code
   # Edit test file to remove dependency on unused code
   cargo test --all-targets  # Verify tests pass without the code

   # Option B: Remove the test if it's testing dead code
   # Remove test that only exercises unused code path

   # Then remove the dead code
   git add wkmp-ai/src/modified_file.rs wkmp-ai/tests/modified_test.rs
   git commit -m "Remove unused function `bar` and refactor tests"
   ```

6. **If tests FAIL for unexpected reason:** ❌ Revert, investigate
   ```bash
   git checkout -- wkmp-ai/src/modified_file.rs
   # Add note to dead_code_report_pre.txt explaining failure
   # Move to Category 2 for further investigation
   ```

**Pass Criteria:** All Category 1 code removed, all tests pass (after refactoring tests as needed)

---

#### Step 6: Handle Category 2 (Review Items)

**For each item in Category 2:**

1. **Investigate usage:**
   - Check git history: `git log -p -- file.rs` (when was it last used?)
   - Search workspace: `rg "function_name" .` (any external references?)
   - Check feature flags: Is it used in Full vs. Lite builds?

2. **Decision:**
   - **Remove:** Move to Category 1, follow removal procedure
   - **Keep:** Move to Category 3, add documentation (REQ-DC-040)

---

#### Step 7: Document Category 3 (Retained Code)

**For each item in Category 3:**

Add #[allow(dead_code)] with explanation comment:

```rust
/// Used by external analysis tools (not detected by compiler)
#[allow(dead_code)]
pub fn export_database_schema() -> String {
    // ...
}
```

**Pass Criteria:** All Category 3 items documented per REQ-DC-040

---

#### Step 8: Final Verification

**Run comprehensive checks:**

```bash
# 1. Zero clippy warnings
cargo clippy --all-targets --all-features -- -W unused
# Expected: no warnings

# 2. Clean build
cargo build --all-targets --all-features
# Expected: no warnings

# 3. All tests pass
cargo test --all-targets
# Expected: all pass

# 4. Coverage unchanged or improved
cargo tarpaulin --all-features
# Expected: coverage % >= baseline
```

**Pass Criteria:** All checks pass with zero warnings

---

### Pass Criteria (Overall)

**PASS if:**
- ✅ All Category 1 code removed
- ✅ All Category 2 code either removed or documented
- ✅ All Category 3 code documented per REQ-DC-040
- ✅ cargo clippy reports zero unused warnings
- ✅ cargo build succeeds with zero warnings
- ✅ cargo test passes (100% existing tests)
- ✅ Git history shows incremental commits (easy to review)

### Fail Criteria

**FAIL if:**
- ❌ cargo clippy still reports unused warnings
- ❌ cargo build has errors
- ❌ Any tests fail after removal
- ❌ Dead code removed without testing (no commits)

---

## Revert Procedure (ISSUE-005 Resolution)

**If removal breaks tests:**

1. **Immediate revert:**
   ```bash
   git checkout -- wkmp-ai/src/broken_file.rs
   ```

2. **Re-run tests to confirm fix:**
   ```bash
   cargo test
   ```

3. **Document in dead_code_report_pre.txt:**
   ```
   ## Category 2: Review Before Removal
   - [ ] file.rs:45 - function `foo` (marked unused by clippy)
     Note: Removing breaks test_bar - investigate usage
   ```

4. **Add #[allow(dead_code)] with TODO:**
   ```rust
   /// TODO: Investigate why clippy marks this unused
   /// Removing breaks test_bar - check for macro usage?
   #[allow(dead_code)]
   fn foo() { ... }
   ```

5. **Continue with next item**

**Do NOT skip testing after each removal.**

---

## Tools and Commands Reference

### Detection Commands

```bash
# Primary detection
cargo clippy --all-targets --all-features -- -W unused

# Secondary detection
cargo build --all-targets --all-features

# Search for patterns
rg "if false" wkmp-ai/src
rg "TODO" wkmp-ai/src
rg "#\[allow\(dead_code\)\]" wkmp-ai/src
rg "#\[cfg\(" wkmp-ai/src

# Find large unused functions
cargo bloat --release --crates (shows code size, may reveal unused)
```

### Verification Commands

```bash
# Zero warnings check
cargo clippy --all-targets --all-features -- -D warnings

# Test suite
cargo test --all-targets

# Coverage (if available)
cargo tarpaulin --all-features --out Stdout
```

---

## Expected Effort

**Detection (Steps 1-4):** 1-2 hours
- cargo clippy: 5 minutes
- Manual review: 45-90 minutes
- Categorization: 15-30 minutes

**Removal (Steps 5-7):** 2-4 hours
- Depends on amount of dead code found
- Incremental testing takes time

**Verification (Step 8):** 30 minutes
- Final checks and documentation

**Total:** 4-8 hours (per scope statement estimate)

---

## Success Metrics

**Quantitative:**
- Dead code items removed: [COUNT]
- Compiler warnings: Before [N] → After 0
- Test pass rate: 100% maintained

**Qualitative:**
- Codebase easier to navigate (fewer unused items)
- Git history shows careful, incremental approach
- Documentation complete for retained code

---

## Test Data Requirements

**None** - This is a code quality test, not a functional test.

**Environment:** Standard development environment with Rust toolchain.

---

## Dependencies

### Tools Required
- cargo 1.70+ (stable)
- cargo-clippy (rustup component add clippy)
- ripgrep (rg command) - optional but recommended
- git (version control)

### Code Dependencies
- None - this test analyzes existing code

---

## Output Artifacts

**1. dead_code_report_pre.txt**
- List of all dead code found
- Categorization (1/2/3)
- Removal status (checkboxes)

**2. Git commits**
- One commit per file modified
- Clear commit messages
- Easy to review and revert if needed

**3. Documentation updates**
- #[allow(dead_code)] annotations added
- Comments explaining retention rationale

---

## Related Tests

**Depends On:** None (first test in execution order)
**Depended On By:**
- TC-M-DC-010-02 (tests must pass after removal)
- All implementation tests (cleaner baseline)

**Sequence:** Run BEFORE any implementation work

---

## Notes

**This test establishes clean baseline for batch writes implementation.**

Removing dead code first:
- Reduces noise during implementation
- Makes it easier to identify batch writes impact
- Simplifies TC-M-DC-020-01 (post-implementation cleanup)

**Important:** Do NOT rush this step. Incremental removal with testing prevents breaking changes.

---

## Sign-Off

**Test Specified:** 2025-01-15
**Status:** Ready for execution
**Reviewed:** [Pending]

**Resolves Issues:**
- ISSUE-002: Dead code detection method now explicit (cargo clippy + manual review)
- ISSUE-005: Revert procedure defined (git checkout, document, continue)
