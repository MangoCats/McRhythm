# TC-U-BW-010-01: Measure Baseline Lock Acquisitions

**Test ID:** TC-U-BW-010-01
**Test Type:** Unit Test
**Requirement:** REQ-BW-010 (Reduce Lock Acquisitions)
**Priority:** P0 (Critical)
**Created:** 2025-01-15

---

## Purpose

Measure baseline database lock acquisitions per file in the import pipeline BEFORE batch writes optimization.

**Resolves:** ISSUE-001 (Baseline lock acquisitions not quantified)

---

## Test Specification

### Scope

**Component Under Test:** Import pipeline lock acquisition pattern
**Files Involved:**
- wkmp-ai/src/services/workflow_orchestrator/mod.rs
- wkmp-ai/src/db/*.rs (all database helpers)

### Given (Initial Conditions)

1. **Environment Setup:**
   - Clean wkmp.db database (empty, schema applied)
   - Single test audio file (test.flac, ~3-5 minutes duration)
   - MusicBrainz mock responses configured
   - Transaction monitoring enabled (begin_monitored active)

2. **Configuration:**
   - ingest_max_concurrent_jobs = 1 (single worker for predictable counting)
   - ai_database_max_lock_wait_ms = 5000
   - Logging level = DEBUG (to capture transaction logs)

3. **Test Data:**
   - File: test_data/test.flac
   - Expected segments: 1 (single-track file)
   - Expected passages: 1

### When (Action/Input)

1. **Enable Transaction Logging:**
   ```rust
   // In test setup
   tracing_subscriber::fmt()
       .with_max_level(tracing::Level::DEBUG)
       .init();
   ```

2. **Run Import for Single File:**
   ```rust
   let orchestrator = WorkflowOrchestrator::new(db.clone(), event_bus, None);
   orchestrator.import_single_file("test_data/test.flac").await?;
   ```

3. **Capture BEGIN TRANSACTION Log Entries:**
   - Monitor logs for "Beginning monitored transaction" messages
   - Count occurrences per file

### Then (Expected Result)

1. **Lock Acquisition Count:**
   - Count total BEGIN TRANSACTION log entries
   - Record count as BASELINE_LOCKS
   - Expected range: 10-30 (based on conversation analysis of ~102 writes / ~10 files)

2. **Per-Phase Breakdown:**
   - SCANNING: 0-1 locks
   - EXTRACTING: 1-2 locks (file metadata)
   - FINGERPRINTING: 3-5 locks (song, artist, album creates)
   - SEGMENTING: 1-2 locks (passage creates)
   - ANALYZING: 1-3 locks (passage metadata updates)
   - FLAVORING: 1-2 locks (flavor vector updates)

3. **Documentation:**
   - Save baseline count to file: `test_results/baseline_locks.txt`
   - Format: `BASELINE_LOCKS=[count]`

### Verify (Specific Assertions)

```rust
#[tokio::test]
async fn test_measure_baseline_lock_acquisitions() {
    // Setup
    let (db, _temp_dir) = setup_test_database().await;
    let event_bus = EventBus::new();

    // Capture logs
    let (tx, mut rx) = tokio::sync::mpsc::channel(100);
    let _guard = tracing_subscriber::fmt()
        .with_writer(move || LogCapture::new(tx.clone()))
        .init();

    // Execute import
    let orchestrator = WorkflowOrchestrator::new(db.clone(), event_bus, None);
    orchestrator.import_single_file("test_data/test.flac").await.unwrap();

    // Count BEGIN TRANSACTION occurrences
    let mut lock_count = 0;
    while let Some(log_entry) = rx.try_recv().ok() {
        if log_entry.contains("Beginning monitored transaction") {
            lock_count += 1;
        }
    }

    // Assert reasonable range
    assert!(lock_count >= 5, "Expected at least 5 locks, got {}", lock_count);
    assert!(lock_count <= 50, "Expected at most 50 locks, got {}", lock_count);

    // Save baseline
    std::fs::write("test_results/baseline_locks.txt",
                   format!("BASELINE_LOCKS={}", lock_count)).unwrap();

    println!("âœ… Baseline lock acquisitions: {}", lock_count);
}
```

### Pass Criteria

**PASS if:**
- Test executes successfully
- Lock count is in reasonable range (5-50 per file)
- Baseline value saved to file
- Import completes without errors

**Quantitative:** BASELINE_LOCKS value recorded

### Fail Criteria

**FAIL if:**
- Test crashes or panics
- Cannot count lock acquisitions (logging issue)
- Lock count unreasonably high (>100) or low (<5)
- Import fails with errors

---

## Implementation Notes

### Helper: Log Capture

```rust
struct LogCapture {
    tx: tokio::sync::mpsc::Sender<String>,
}

impl LogCapture {
    fn new(tx: tokio::sync::mpsc::Sender<String>) -> Self {
        Self { tx }
    }
}

impl std::io::Write for LogCapture {
    fn write(&mut self, buf: &[u8]) -> std::io::Result<usize> {
        let s = String::from_utf8_lossy(buf).to_string();
        let _ = self.tx.try_send(s);
        Ok(buf.len())
    }

    fn flush(&mut self) -> std::io::Result<()> {
        Ok(())
    }
}
```

### Alternative: Direct Instrumentation

If log capture is unreliable, instrument begin_monitored directly:

```rust
// In wkmp-ai/src/utils/pool_monitor.rs (temporary for testing)
static TRANSACTION_COUNT: AtomicUsize = AtomicUsize::new(0);

pub async fn begin_monitored(...) -> ... {
    TRANSACTION_COUNT.fetch_add(1, Ordering::SeqCst);
    // ... existing code ...
}

pub fn reset_transaction_count() {
    TRANSACTION_COUNT.store(0, Ordering::SeqCst);
}

pub fn get_transaction_count() -> usize {
    TRANSACTION_COUNT.load(Ordering::SeqCst)
}
```

---

## Test Data Requirements

### Minimal Test File

**File:** test_data/test.flac
**Properties:**
- Format: FLAC
- Duration: 3-5 minutes
- Channels: 2 (stereo)
- Sample rate: 44100 Hz
- ID3 tags: Artist, Title, Album
- MusicBrainz ID: Known (mock response available)

**Why:** Single-track file produces predictable lock pattern

### Mock Responses

**MusicBrainz:** Provide mock response for known MBID
**AcoustID:** Provide mock fingerprint response
**AcousticBrainz:** Provide mock flavor vector

---

## Dependencies

### Code Dependencies
- `wkmp_common::config::RootFolderResolver` (database path)
- `wkmp_common::events::EventBus` (orchestrator dependency)
- `wkmp-ai/src/utils/pool_monitor::begin_monitored` (transaction monitoring)

### External Dependencies
- tokio::test (async testing)
- tracing_subscriber (log capture)
- tempfile (temporary test database)

### Configuration
- Test database schema (migrations applied)
- Mock API responses configured

---

## Estimated Effort

**Implementation:** 30-45 minutes
- Log capture setup: 15 minutes
- Test implementation: 15 minutes
- Verification: 10 minutes
- Documentation: 5 minutes

**Execution Time:** 10-20 seconds per run

---

## Success Metrics

**Primary:**
- Baseline lock count recorded: [VALUE] locks per file

**Secondary:**
- Per-phase breakdown available (optional, informational)

---

## Notes

**This is a baseline measurement test, not a pass/fail test.**

The purpose is to establish BASELINE_LOCKS value for comparison in TC-I-BW-010-02.

Any reasonable count (5-50) is acceptable - we need the number for ratio calculation.

---

## Related Tests

**Depends On:** None (this is the first test)
**Depended On By:**
- TC-I-BW-010-02 (uses this baseline for reduction calculation)

**Sequence:** Run FIRST in test execution order

---

## Sign-Off

**Test Specified:** 2025-01-15
**Status:** Ready for implementation
**Reviewed:** [Pending]
