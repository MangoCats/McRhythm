# TC-SEC-001-01: POST with Valid Secret Succeeds

**Test Type:** Unit Test (HTTP API)
**Requirements:** REQ-DEBT-SEC-001-010, REQ-DEBT-SEC-001-020, REQ-DEBT-SEC-001-030
**Sprint:** 1 (Security & Critical)
**Estimated Effort:** 30 minutes

---

## Test Scope

**Component Under Test:** `wkmp-ap/src/api/auth_middleware.rs` - POST authentication

**Purpose:** Verify that POST requests with valid shared_secret in JSON body are authenticated successfully

---

## Test Specification

### Given
- wkmp-ap server running with shared_secret = "test-secret-123"
- HTTP client configured to send JSON requests
- `/api/queue` endpoint exists and accepts POST

### When
- Client sends POST request to `/api/queue`
- Request body contains JSON: `{"passage_id": "test-uuid", "shared_secret": "test-secret-123"}`
- Content-Type header is `application/json`

### Then
- Response status code is 200 OK (or appropriate success code for endpoint)
- Request proceeds to handler (not rejected by middleware)
- Response body matches expected successful operation result

---

## Verification Steps

```rust
#[tokio::test]
async fn test_post_with_valid_secret_succeeds() {
    // Setup
    let (server, secret) = spawn_test_server().await;
    let client = reqwest::Client::new();
    let url = format!("{}/api/queue", server.addr());

    // Execute
    let response = client
        .post(&url)
        .json(&json!({
            "passage_id": "550e8400-e29b-41d4-a716-446655440000",
            "shared_secret": secret
        }))
        .send()
        .await
        .expect("Failed to send request");

    // Verify
    assert_eq!(
        response.status(),
        StatusCode::OK,
        "Expected 200 OK for authenticated POST request"
    );

    // Additional: Verify request reached handler (check queue updated)
    let queue = server.get_queue().await;
    assert!(!queue.is_empty(), "Queue should have entry after successful POST");
}
```

---

## Pass Criteria

- [ ] Test compiles without errors
- [ ] Test runs without panics
- [ ] Response status is 200 OK
- [ ] Request is processed by handler (queue entry created)
- [ ] No authentication errors in logs

## Fail Criteria

- Response status is 401 Unauthorized
- Response status is 500 Internal Server Error
- Request is rejected before reaching handler
- Test panics or times out

---

## Test Data

**Valid Shared Secret:** Any string matching server configuration
**Test Passage ID:** `550e8400-e29b-41d4-a716-446655440000` (valid UUID format)

---

## Dependencies

- wkmp-ap server must be running
- `/api/queue` endpoint must exist
- JSON serialization working (serde_json)

---

## Notes

- This test verifies the "happy path" for POST authentication
- Edge cases (invalid secret, missing field) covered in separate tests
- Test assumes shared_secret field is extracted from JSON body correctly
