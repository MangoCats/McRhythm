# TC-U-023-01: Bayesian Update - Agreement Case

**Test ID:** TC-U-023-01
**Test Type:** Unit Test
**Requirement:** REQ-AI-023 (Bayesian Update Algorithm)
**Priority:** Critical Path
**Estimated Effort:** 30 minutes (write + implement)

---

## Test Objective

Verify that Bayesian update algorithm correctly strengthens confidence when ID3 MBID and AcoustID MBID agree.

---

## Test Specification

### Given (Setup)

**Input Data:**
```rust
let input = IdentityResolverInput {
    id3_mbid: Some(Uuid::parse_str("abc-123...").unwrap()),
    acoustid_result: AcoustIDResult {
        mbid: Some(Uuid::parse_str("abc-123...").unwrap()),  // SAME as ID3
        confidence: 0.9,
    },
};
```

**Expected Behavior:**
- Prior confidence (ID3): 0.9
- AcoustID confidence: 0.9
- MBIDs match → Agreement case

### When (Action)

```rust
let result = identity_resolver.resolve_identity(input);
```

### Then (Expected Result)

**Assertions:**

```rust
// 1. Final MBID should be the agreed-upon MBID
assert_eq!(result.recording_mbid, Some(Uuid::parse_str("abc-123...").unwrap()));

// 2. Posterior confidence should be calculated via Bayesian agreement formula:
//    posterior = 1 - (1 - prior) * (1 - acoustid)
//    posterior = 1 - (1 - 0.9) * (1 - 0.9)
//    posterior = 1 - (0.1) * (0.1)
//    posterior = 1 - 0.01 = 0.99
let expected_confidence = 1.0 - (1.0 - 0.9) * (1.0 - 0.9);
assert!((result.confidence - expected_confidence).abs() < 0.0001);

// 3. Source should indicate agreement
assert_eq!(result.source, "AcoustID+ID3 (agreement)");

// 4. No conflicts should be present
assert!(result.conflicts.is_empty());

// 5. No flags should be set (high confidence)
assert!(result.flags.is_empty());
```

---

## Pass Criteria

**Test passes if:**
1. ✅ Final MBID matches input MBIDs (abc-123...)
2. ✅ Posterior confidence = 0.99 ± 0.0001
3. ✅ Source = "AcoustID+ID3 (agreement)"
4. ✅ Conflicts vec is empty
5. ✅ Flags vec is empty

**Test fails if:**
- ❌ Confidence is not strengthened (not higher than max of prior/acoustid)
- ❌ Conflicts reported when MBIDs agree
- ❌ Posterior confidence formula incorrect

---

## Test Data

**Test Case Variations:**

| Variation | Prior Conf | AcoustID Conf | Expected Posterior |
|-----------|------------|---------------|---------------------|
| Baseline  | 0.9        | 0.9           | 0.99                |
| High/Low  | 0.9        | 0.6           | 0.96                |
| Low/High  | 0.6        | 0.9           | 0.96                |
| Both Low  | 0.5        | 0.5           | 0.75                |
| Both High | 0.95       | 0.95          | 0.9975              |

**Each variation should pass with correct posterior confidence calculation.**

---

## Implementation Notes

**Module Under Test:** `fusion/fusers/identity_resolver.rs`

**Function Under Test:** `IdentityResolver::resolve_identity()`

**Dependencies:**
- None (pure function, no external calls)

**Mock Requirements:**
- None (test uses real data structures)

---

## Traceability

**Requirement:** REQ-AI-023 (Bayesian Update Algorithm) - Line 117
**Specific Statement:** "If ID3 MBID == AcoustID MBID: `posterior_confidence = 1 - (1 - prior_conf) * (1 - acoustid_conf)`"

**Related Tests:**
- TC-U-023-02 (Conflict case)
- TC-U-023-03 (Single source case)

---

## Status

- [ ] Test Specification Written
- [ ] Test Implemented
- [ ] Test Passing
- [ ] Code Coverage Verified

**Last Updated:** 2025-01-08
