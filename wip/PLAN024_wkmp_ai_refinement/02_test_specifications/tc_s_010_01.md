# TC-S-010-01: Silence-Based Segmentation - End-to-End Import

**Test ID:** TC-S-010-01
**Test Type:** System Test (End-to-End)
**Requirement:** REQ-SPEC032-010 (Silence-Based Segmentation)
**Components:** Full wkmp-ai import pipeline
**Priority:** P0 (Critical)
**Estimated Effort:** 2 hours (write + implement + test data creation)

---

## Test Objective

Verify that a real audio file containing two songs separated by silence is correctly segmented into two distinct passages during end-to-end import workflow.

---

## Test Specification

### Environment Setup

**Test Environment:**
- wkmp-ai microservice running on localhost:5723
- Real SQLite database (wkmp.db in temporary folder)
- Real audio file (not mock)

**Configuration:**
- Root folder: /tmp/test_import/
- Settings table populated with default values:
  - silence_threshold_dB: 35.0 (default)
  - silence_min_duration_ticks: 300ms converted to ticks (default)
  - minimum_passage_audio_duration_ticks: 100ms converted to ticks (default)

### Test Data

**Audio File:** `two_songs.mp3`
- **Location:** /tmp/test_import/two_songs.mp3
- **Content:**
  - Song 1: "Track A" - 0:00 to 3:00 (180 seconds)
  - Silence: 3:00 to 3:03 (3 seconds, -50dB RMS)
  - Song 2: "Track B" - 3:03 to 6:00 (177 seconds)
- **Total Duration:** 6:00 (360 seconds)
- **Expected Passages:** 2
  - Passage 1: start=0, end=180s
  - Passage 2: start=183s, end=360s

**Metadata (ID3 Tags):**
- Artist: "Test Artist"
- Album: "Test Album"
- Title: Not set (ambiguous - contains two songs)

### Scenario (User Actions)

**Step 1:** User starts wkmp-ai
```bash
cargo run -p wkmp-ai
```

**Step 2:** User navigates to http://localhost:5723 in browser

**Step 3:** User completes API key validation (provides valid AcoustID key or acknowledges lack)

**Step 4:** User selects folder to scan: `/tmp/test_import/`

**Step 5:** User clicks "Start Import"

**Step 6:** wkmp-ai processes file through 10-phase pipeline:
1. FILENAME MATCHING → No match found, assign new fileId
2. HASHING → Compute hash, no duplicates found
3. EXTRACTING → Extract ID3 metadata (artist, album)
4. SEGMENTING → **Detect silence at 3:00-3:03, create 2 potential passages**
5. FINGERPRINTING → Fingerprint both passages
6. SONG MATCHING → Match passage 1 to "Track A", passage 2 to "Track B"
7. RECORDING → Record 2 passages in database
8. AMPLITUDE → Detect lead-in/lead-out for both passages
9. FLAVORING → Retrieve musical flavor for both songs
10. PASSAGES COMPLETE → Mark file 'INGEST COMPLETE'

**Step 7:** User observes UI progress sections updating in real-time

**Step 8:** Import completes

### Given (Pre-Conditions)

✅ wkmp-ai running and accessible
✅ Database empty (no prior imports)
✅ Audio file `two_songs.mp3` exists at `/tmp/test_import/two_songs.mp3`
✅ AcoustID API accessible (or acknowledged as unavailable)
✅ Settings table has default values

### When (System Actions)

**System automatically:**
1. Scans folder → Finds `two_songs.mp3`
2. Processes file through 10 phases
3. Detects silence boundary at 3:00-3:03
4. Creates 2 potential passages
5. Fingerprints and matches both passages
6. Records passages in database
7. Marks file 'INGEST COMPLETE'

### Then (Expected Results)

**Database State After Import:**

**files table:**
| fileId | path | filename | status |
|--------|------|----------|--------|
| [uuid] | /tmp/test_import/two_songs.mp3 | two_songs.mp3 | INGEST COMPLETE |

**passages table:**
| passageId | fileId | start_ticks | end_ticks | status |
|-----------|--------|-------------|-----------|--------|
| [uuid-1] | [file-uuid] | 0 | ~8640000000 (180s in ticks) | INGEST COMPLETE |
| [uuid-2] | [file-uuid] | ~8784000000 (183s in ticks) | ~17280000000 (360s in ticks) | INGEST COMPLETE |

**songs table:**
| songId | mbid | title | status |
|--------|------|-------|--------|
| [uuid-A] | [mbid-A] | Track A | FLAVOR READY (or FLAVORING FAILED) |
| [uuid-B] | [mbid-B] | Track B | FLAVOR READY (or FLAVORING FAILED) |

**UI Display:**
- SCANNING: "1 potential files found"
- PROCESSING: "Processing 1 to 1 of 1"
- SEGMENTING: "1 files, 2 potential passages, 2 finalized passages, 2 songs identified"
- PASSAGES COMPLETE: "2"
- FILES COMPLETE: "1"

### Verify (Assertions)

**Assertion 1:** Exactly 2 passages created
```rust
let count = db.query_one("SELECT COUNT(*) FROM passages WHERE fileId = ?", [file_id]).await?;
assert_eq!(count.get::<i32>(0), 2);
```

**Assertion 2:** Passages have correct timing (within tolerance)
```rust
let passages = db.query("SELECT start_ticks, end_ticks FROM passages WHERE fileId = ? ORDER BY start_ticks", [file_id]).await?;

// Passage 1: 0 to ~180s (tolerance: ±1s = ±48000000 ticks)
assert!(passages[0].get::<i64>("start_ticks") < 48000000); // ~0s
assert!((passages[0].get::<i64>("end_ticks") - 8640000000).abs() < 48000000); // ~180s

// Passage 2: ~183s to ~360s (tolerance: ±1s)
assert!((passages[1].get::<i64>("start_ticks") - 8784000000).abs() < 48000000); // ~183s
assert!((passages[1].get::<i64>("end_ticks") - 17280000000).abs() < 48000000); // ~360s
```

**Assertion 3:** Both passages have status 'INGEST COMPLETE'
```rust
for passage in passages.iter() {
    assert_eq!(passage.get::<String>("status"), "INGEST COMPLETE");
}
```

**Assertion 4:** Two distinct songs identified
```rust
let song_count = db.query_one("SELECT COUNT(DISTINCT songId) FROM passage_songs WHERE passageId IN (SELECT passageId FROM passages WHERE fileId = ?)", [file_id]).await?;
assert_eq!(song_count.get::<i32>(0), 2);
```

**Assertion 5:** File marked 'INGEST COMPLETE'
```rust
let status = db.query_one("SELECT status FROM files WHERE fileId = ?", [file_id]).await?;
assert_eq!(status.get::<String>("status"), "INGEST COMPLETE");
```

**Assertion 6:** UI displayed 2 passages in SEGMENTING section (manual verification or SSE event capture)

### Pass Criteria

✅ All 6 assertions pass
✅ Import completes without errors
✅ UI progress sections display correct statistics
✅ Both passages playable in wkmp-ap (verify separately)
✅ Total execution time < 60 seconds (performance acceptable)

### Fail Criteria

❌ Only 1 passage created (silence not detected)
❌ More than 2 passages created (false silence detection)
❌ Passage timing incorrect (off by >1 second)
❌ Songs not identified (zero-song passages)
❌ File not marked 'INGEST COMPLETE'
❌ Import errors or hangs

---

## Test Data Creation

### Option 1: Synthetic Audio File

**Create using ffmpeg:**
```bash
# Generate 180s tone (1kHz) for Track A
ffmpeg -f lavfi -i "sine=frequency=1000:duration=180" -ar 48000 track_a.wav

# Generate 3s silence
ffmpeg -f lavfi -i "anullsrc=r=48000:cl=mono" -t 3 silence.wav

# Generate 177s tone (800Hz) for Track B
ffmpeg -f lavfi -i "sine=frequency=800:duration=177" -ar 48000 track_b.wav

# Concatenate Track A + Silence + Track B
ffmpeg -i "concat:track_a.wav|silence.wav|track_b.wav" -c:a libmp3lame two_songs.mp3

# Add ID3 tags
id3v2 -a "Test Artist" -A "Test Album" two_songs.mp3
```

### Option 2: Real Audio File

**Use existing music file with known structure:**
- Example: Pink Floyd "Dark Side of the Moon" - Track 7 "Money" followed by brief silence, then track 8 "Us and Them"
- Verify silence gap exists and is detectable (≥3 seconds, ≤-35dB RMS)

---

## Implementation Notes

**Silence Detection Algorithm:**
1. Decode audio to PCM samples (48kHz, mono or stereo averaged)
2. Calculate RMS amplitude in 100ms windows
3. If RMS < silence_threshold_dB for ≥ silence_min_duration_ticks → Mark as silence
4. Segment boundaries = transitions from audio → silence and silence → audio

**Tick Conversion (SPEC017):**
- 48kHz sample rate
- 1 tick = 1 sample / 48000 seconds
- 180 seconds = 180 × 48000 = 8,640,000 ticks (not 8,640,000,000 as shown above - correction needed)

**Correct Tick Calculation:**
- Check SPEC017 for exact tick definition
- Use `wkmp_common::ticks::from_seconds()` conversion function

---

## Edge Cases

**Case 1:** Silence shorter than minimum duration (e.g., 100ms pause)
- Expected: NOT detected as passage boundary
- Behavior: Treated as single passage

**Case 2:** Silence at exact minimum duration (300ms)
- Expected: Detected as passage boundary
- Behavior: Two passages created

**Case 3:** Very long silence (e.g., 30 seconds)
- Expected: Detected as passage boundary
- Behavior: Two passages created (silence gap not stored as passage)

---

## Related Tests

- **TC-U-010-01:** Unit test - silence detection algorithm
- **TC-U-010-03:** Unit test - NO AUDIO file detection (<100ms non-silence)
- **TC-I-010-01:** Integration test - settings table → silence detection
- **TC-S-012-01:** System test - song matching with confidence

---

## Traceability

| Item | Reference |
|------|-----------|
| **Requirement** | REQ-SPEC032-010 (Silence-Based Segmentation) |
| **Specification** | [SPEC032_wkmp-ai_refinement_specification.md](../../wip/SPEC032_wkmp-ai_refinement_specification.md) lines 359-365 |
| **Implementation** | wkmp-ai/src/services/silence_detector.rs (to be modified) |
| **Status** | Defined (ready for implementation after test data created) |
