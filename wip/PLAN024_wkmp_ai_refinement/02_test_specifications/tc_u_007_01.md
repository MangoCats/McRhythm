# TC-U-007-01: Filename Matching - Completed File Skip

**Test ID:** TC-U-007-01
**Test Type:** Unit Test
**Requirement:** REQ-SPEC032-007 (Filename Matching Logic)
**Component:** `wkmp-ai/src/services/filename_matcher.rs`
**Priority:** P0 (Critical)
**Estimated Effort:** 30 minutes (write + implement)

---

## Test Objective

Verify that the filename matcher correctly skips files that already exist in the database with status 'INGEST COMPLETE', avoiding redundant re-processing.

---

## Test Specification

### Given (Initial Conditions)

**Database State:**
- files table contains entry:
  - fileId: `existing-file-uuid`
  - path: `/Music/Test/song.mp3`
  - filename: `song.mp3`
  - created_at: 2024-01-01 12:00:00
  - modified_at: 2024-01-01 12:00:00
  - status: `'INGEST COMPLETE'`

**File System:**
- File exists at `/Music/Test/song.mp3`
- File metadata matches database (created/modified timestamps identical)

### When (Action/Input)

**Action:** Call `FilenameMatch::check_existing(&db, "/Music/Test/song.mp3", file_metadata)`

**Input Parameters:**
- `db`: Database connection
- `path`: "/Music/Test/song.mp3"
- `file_metadata`: FileMetadata {
    created_at: 2024-01-01 12:00:00,
    modified_at: 2024-01-01 12:00:00
  }

### Then (Expected Result)

**Return Value:** `FilenameMatchResult::SkipCompleted(existing-file-uuid)`

**Behavior:**
- Function returns immediately (no further processing)
- No new database row created
- Existing fileId returned for logging/statistics

### Verify (Specific Assertions)

**Assertion 1:** Return value is `FilenameMatchResult::SkipCompleted` variant
```rust
assert!(matches!(result, FilenameMatchResult::SkipCompleted(_)));
```

**Assertion 2:** Returned fileId matches existing database entry
```rust
if let FilenameMatchResult::SkipCompleted(file_id) = result {
    assert_eq!(file_id, Uuid::parse_str("existing-file-uuid").unwrap());
}
```

**Assertion 3:** Database files table unchanged (row count same)
```rust
let count_after = db.query_one("SELECT COUNT(*) FROM files").await?;
assert_eq!(count_before, count_after);
```

**Assertion 4:** No duplicate entry created
```rust
let entries = db.query("SELECT * FROM files WHERE path = '/Music/Test/song.mp3'").await?;
assert_eq!(entries.len(), 1); // Still only one entry
```

### Pass Criteria

✅ All 4 assertions pass
✅ Function executes in <10ms (database query performance)
✅ No exceptions/errors thrown

### Fail Criteria

❌ Function returns different variant (ReuseExisting or AssignNew)
❌ New database row created (duplicate entry)
❌ Incorrect fileId returned
❌ Exception thrown

---

## Test Data

**Database Fixture:**
```sql
INSERT INTO files (fileId, path, filename, created_at, modified_at, status)
VALUES ('existing-file-uuid', '/Music/Test/song.mp3', 'song.mp3',
        '2024-01-01 12:00:00', '2024-01-01 12:00:00', 'INGEST COMPLETE');
```

**File Metadata Mock:**
```rust
FileMetadata {
    created_at: DateTime::parse_from_rfc3339("2024-01-01T12:00:00Z").unwrap(),
    modified_at: DateTime::parse_from_rfc3339("2024-01-01T12:00:00Z").unwrap(),
}
```

---

## Implementation Notes

**Database Query Expected:**
```sql
SELECT fileId, status FROM files
WHERE path = ? AND filename = ? AND created_at = ? AND modified_at = ?
LIMIT 1;
```

**Decision Logic:**
```rust
if let Some(row) = query_result {
    if row.get("status") == "INGEST COMPLETE" {
        return FilenameMatchResult::SkipCompleted(row.get("fileId"));
    } else {
        return FilenameMatchResult::ReuseExisting(row.get("fileId"));
    }
} else {
    return FilenameMatchResult::AssignNew(Uuid::new_v4());
}
```

---

## Related Tests

- **TC-U-007-02:** Filename matching - reuse existing fileId (status != 'INGEST COMPLETE')
- **TC-U-007-03:** Filename matching - assign new fileId (no match found)
- **TC-I-007-01:** Integration test - full filename matching workflow with database

---

## Traceability

| Item | Reference |
|------|-----------|
| **Requirement** | REQ-SPEC032-007 (Filename Matching Logic) |
| **Specification** | [SPEC032_wkmp-ai_refinement_specification.md](../../wip/SPEC032_wkmp-ai_refinement_specification.md) lines 339-343 |
| **Implementation** | wkmp-ai/src/services/filename_matcher.rs (to be created) |
| **Status** | Defined (ready for implementation) |
