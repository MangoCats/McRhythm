# Integration Tests: End-to-End Resolution (tc_i_e2e_001 to tc_i_e2e_004)

**Test Category:** Integration Tests
**Component:** wkmp-ai startup sequence with key resolution
**Requirements Covered:** APIK-RES-010 through 050, APIK-ACID-010, APIK-LOG-010 through 040, APIK-MIG-010

---

## tc_i_e2e_001: wkmp-ai Startup with Database Key

**Requirement:** [APIK-RES-010], [APIK-RES-020], [APIK-LOG-010]

**Setup:**
- Test database with acoustid_api_key = "test-db-key"
- ENV not set
- TOML not set

**Execution:**
- Start wkmp-ai module (full initialization)
- Check logs during startup

**Expected Result:**
- Module starts successfully
- AcoustID client initialized with "test-db-key"
- Log: "INFO: AcoustID API key: Loaded from database"
- No migration occurs

**Verification:**
- Assert module running (HTTP server responds)
- Assert log contains "Loaded from database"
- Assert no errors in startup logs

---

## tc_i_e2e_002: wkmp-ai Startup with ENV Migration

**Requirement:** [APIK-RES-030], [APIK-WB-010], [APIK-LOG-030], [APIK-MIG-010]

**Setup:**
- Empty test database
- ENV: WKMP_ACOUSTID_API_KEY="test-env-key"
- TOML empty

**Execution:**
- Start wkmp-ai module

**Expected Result:**
- Module starts successfully
- Key migrated from ENV to database and TOML
- Logs:
  ```
  INFO: AcoustID API key: Loaded from environment variable
  INFO: Migrating API key to database for persistence...
  INFO: API key saved to database
  INFO: API key backed up to TOML config
  ```
- Database now contains "test-env-key"
- TOML now contains "test-env-key"

**Verification:**
- Assert module running
- Assert database contains key
- Assert TOML contains key
- Assert migration logs present

---

## tc_i_e2e_003: wkmp-ai Startup with TOML Migration

**Requirement:** [APIK-RES-040], [APIK-WB-020], [APIK-LOG-010]

**Setup:**
- Empty test database
- ENV not set
- TOML: acoustid_api_key = "test-toml-key"

**Execution:**
- Start wkmp-ai module

**Expected Result:**
- Module starts successfully
- Key migrated from TOML to database (TOML unchanged)
- Logs:
  ```
  INFO: AcoustID API key: Loaded from TOML config
  INFO: Migrating API key to database for persistence...
  INFO: API key saved to database
  ```
- Database now contains "test-toml-key"
- TOML unchanged (already contains key)

**Verification:**
- Assert module running
- Assert database contains key
- Assert TOML unchanged
- Assert no "backed up to TOML" log

---

## tc_i_e2e_004: wkmp-ai Startup Error on No Key

**Requirement:** [APIK-RES-050], [APIK-ERR-010]

**Setup:**
- Empty test database
- ENV not set
- TOML empty

**Execution:**
- Attempt to start wkmp-ai module

**Expected Result:**
- Module startup fails with clear error
- Error message contains:
  - "AcoustID API key not found"
  - "Database: acoustid_api_key (empty)"
  - "Environment: WKMP_ACOUSTID_API_KEY (not set)"
  - "TOML: ~/.config/wkmp/wkmp-ai.toml (acoustid_api_key not found)"
  - "Obtain free key: https://acoustid.org/api-key"
- Module does not start

**Verification:**
- Assert module startup failed (exit code non-zero or panic)
- Assert error message contains all 3 methods
- Assert error message contains acoustid.org link

---

**Test File:** tc_i_e2e_001_to_004.md
**Total Tests:** 4
**Requirements Coverage:** APIK-RES-010 through 050, APIK-WB-010, 020, APIK-LOG-010 through 040, APIK-ACID-010, APIK-ERR-010, APIK-MIG-010
