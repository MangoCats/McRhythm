# TC-U-010-01: List All Tables Query

**Test ID:** TC-U-010-01
**Requirement:** REQ-DR-F-010 (Table-by-Table Raw Content Viewing)
**Test Type:** Unit Test
**Priority:** P0
**Estimated Time:** 2 minutes

---

## Objective

Verify that database query function correctly retrieves list of all tables in wkmp.db with row counts.

---

## Scope

**Component Under Test:** `wkmp-dr/src/db/tables.rs::list_all_tables()`

**Dependencies:**
- SQLite database connection (read-only)
- Test database with known schema

---

## Test Specification

### Given
- Test database `test_wkmp.db` exists with standard WKMP schema
- Database contains following tables:
  - `users` (5 rows)
  - `settings` (12 rows)
  - `module_config` (5 rows)
  - `files` (50 rows)
  - `passages` (200 rows)
  - `queue` (10 rows)
  - `songs` (100 rows)
  - `artists` (50 rows)
  - `albums` (20 rows)
  - `works` (80 rows)
  - `passage_songs` (150 rows)
  - `song_artists` (200 rows)
  - `passage_albums` (100 rows)
  - `acoustid_cache` (75 rows)
  - `schema_version` (1 row)
- Read-only database pool initialized

### When
- Function `list_all_tables(pool)` is called
- Function executes SQL query:
  ```sql
  SELECT name,
         (SELECT COUNT(*) FROM sqlite_master WHERE type='table' AND name=m.name) as row_count
  FROM sqlite_master m
  WHERE type='table'
    AND name NOT LIKE 'sqlite_%'
  ORDER BY name ASC
  ```

### Then
- Function returns `Result<Vec<TableInfo>>` where `TableInfo` contains:
  - `name: String` - table name
  - `row_count: i64` - number of rows in table
- Result contains exactly 15 tables (all WKMP schema tables)
- Tables ordered alphabetically
- Row counts match expected values

---

## Pass Criteria

**PASS if ALL conditions met:**
1. Function returns `Ok(tables)` (no error)
2. `tables.len() == 15`
3. Table names match expected schema (alphabetical order):
   - `acoustid_cache`
   - `albums`
   - `artists`
   - `files`
   - `module_config`
   - `passage_albums`
   - `passage_songs`
   - `passages`
   - `queue`
   - `schema_version`
   - `settings`
   - `song_artists`
   - `songs`
   - `users`
   - `works`
4. Row counts accurate (±0 tolerance):
   - `files`: 50 rows
   - `passages`: 200 rows
   - `songs`: 100 rows
   - (etc. for all tables)
5. Execution time <100ms

---

## Fail Criteria

**FAIL if ANY condition occurs:**
- Function returns `Err(...)` (database error)
- Wrong number of tables returned (≠15)
- Missing expected table (e.g., `passages` not in list)
- Includes SQLite internal tables (e.g., `sqlite_sequence`)
- Row count inaccurate (off by >0)
- Execution time >100ms

---

## Test Implementation

```rust
#[tokio::test]
async fn test_list_all_tables() {
    // Setup: Create test database
    let pool = setup_test_database().await;

    // Execute: Call function under test
    let result = db::tables::list_all_tables(&pool).await;

    // Assert: Verify success
    assert!(result.is_ok(), "list_all_tables should succeed");
    let tables = result.unwrap();

    // Assert: Check table count
    assert_eq!(tables.len(), 15, "Should return exactly 15 tables");

    // Assert: Check table names (alphabetical)
    let table_names: Vec<_> = tables.iter().map(|t| &t.name).collect();
    assert_eq!(table_names[0], "acoustid_cache");
    assert_eq!(table_names[3], "files");
    assert_eq!(table_names[7], "passages");
    // ... (check all 15)

    // Assert: Check specific row counts
    let files_table = tables.iter().find(|t| t.name == "files").unwrap();
    assert_eq!(files_table.row_count, 50, "files table should have 50 rows");

    let passages_table = tables.iter().find(|t| t.name == "passages").unwrap();
    assert_eq!(passages_table.row_count, 200, "passages table should have 200 rows");

    // Performance: Check execution time
    let start = std::time::Instant::now();
    let _ = db::tables::list_all_tables(&pool).await;
    let duration = start.elapsed();
    assert!(duration.as_millis() < 100, "Should complete in <100ms");
}
```

---

## Test Data

**Database:** `tests/fixtures/test_wkmp.db`
**Schema Version:** 1
**Generated By:** `tests/setup_test_db.rs::create_test_database()`

**Row Counts (Known Values):**
```
users: 5
settings: 12
module_config: 5
files: 50
passages: 200
queue: 10
songs: 100
artists: 50
albums: 20
works: 80
passage_songs: 150
song_artists: 200
passage_albums: 100
acoustid_cache: 75
schema_version: 1
```

---

## Edge Cases

**Covered by this test:**
- None (happy path only)

**NOT covered (separate tests):**
- Empty database (0 rows in all tables) → TC-U-010-02
- Corrupted database → TC-I-010-03
- Database with non-WKMP tables → TC-U-010-04

---

## Dependencies

**Code Dependencies:**
- `wkmp-dr/src/db/tables.rs`
- `wkmp-common::db::init` (for test database setup)
- `sqlx::SqlitePool`

**Test Dependencies:**
- `tokio::test` runtime
- `tempfile` crate (for test database)

---

## Traceability

**Requirements Covered:**
- REQ-DR-F-010: Table-by-table raw content viewing (partial - table listing)

**Related Tests:**
- TC-I-010-01: Integration test for GET /api/tables endpoint
- TC-S-UI050-01: System test for table dropdown rendering

---

**Test Specification Complete**
**Status:** Ready for implementation
