{
  "analysis_date": "2025-10-19",
  "analysis_version": "1.0",
  "module": "wkmp-ap",
  "total_test_functions": 226,
  "test_breakdown": {
    "unit_tests": 173,
    "integration_tests": 53,
    "benchmarks": 6,
    "property_tests": 0,
    "ignored_tests": 1
  },
  "total_source_lines": 13719,
  "estimated_overall_coverage_percent": 65,
  "coverage_estimation_method": "Based on test count vs module size, presence of tests, and complexity analysis",

  "coverage_by_module": [
    {
      "module": "playback/buffer_manager.rs",
      "lines_of_code": 1458,
      "test_count": 34,
      "estimated_coverage_percent": 85,
      "critical_untested_functions": [],
      "has_error_tests": true,
      "has_edge_case_tests": true,
      "notes": "Excellent coverage with comprehensive lifecycle and state transition tests"
    },
    {
      "module": "playback/pipeline/mixer.rs",
      "lines_of_code": 1664,
      "test_count": 32,
      "estimated_coverage_percent": 80,
      "critical_untested_functions": [],
      "has_error_tests": true,
      "has_edge_case_tests": true,
      "notes": "Strong coverage for crossfade logic, timing, and audio quality"
    },
    {
      "module": "playback/engine.rs",
      "lines_of_code": 2120,
      "test_count": 9,
      "estimated_coverage_percent": 45,
      "critical_untested_functions": [
        "Cold startup timing",
        "Error recovery paths",
        "State machine edge cases"
      ],
      "has_error_tests": false,
      "has_edge_case_tests": false,
      "notes": "Core orchestration logic, but limited unit tests. Integration tests cover some paths."
    },
    {
      "module": "playback/decoder_pool.rs",
      "lines_of_code": 515,
      "test_count": 2,
      "estimated_coverage_percent": 30,
      "critical_untested_functions": [
        "Worker thread lifecycle",
        "Task queue overflow",
        "Decode error propagation"
      ],
      "has_error_tests": false,
      "has_edge_case_tests": false,
      "notes": "Critical component with minimal unit testing"
    },
    {
      "module": "playback/ring_buffer.rs",
      "lines_of_code": 470,
      "test_count": 7,
      "estimated_coverage_percent": 70,
      "critical_untested_functions": [],
      "has_error_tests": true,
      "has_edge_case_tests": true,
      "notes": "Good coverage for lock-free buffer operations"
    },
    {
      "module": "playback/queue_manager.rs",
      "lines_of_code": 443,
      "test_count": 8,
      "estimated_coverage_percent": 75,
      "critical_untested_functions": [],
      "has_error_tests": true,
      "has_edge_case_tests": true,
      "notes": "Solid coverage of queue operations"
    },
    {
      "module": "playback/song_timeline.rs",
      "lines_of_code": 453,
      "test_count": 9,
      "estimated_coverage_percent": 80,
      "critical_untested_functions": [],
      "has_error_tests": true,
      "has_edge_case_tests": true,
      "notes": "Good coverage of timing calculations"
    },
    {
      "module": "playback/pipeline/timing.rs",
      "lines_of_code": 408,
      "test_count": 8,
      "estimated_coverage_percent": 75,
      "critical_untested_functions": [],
      "has_error_tests": true,
      "has_edge_case_tests": true,
      "notes": "Strong coverage of sample-accurate timing"
    },
    {
      "module": "audio/decoder.rs",
      "lines_of_code": 600,
      "test_count": 1,
      "estimated_coverage_percent": 20,
      "critical_untested_functions": [
        "Decode error handling",
        "Corrupt file handling",
        "Seek precision",
        "Format detection"
      ],
      "has_error_tests": false,
      "has_edge_case_tests": false,
      "notes": "Critical audio decoding with minimal unit tests. Integration tests exist."
    },
    {
      "module": "audio/output.rs",
      "lines_of_code": 618,
      "test_count": 4,
      "estimated_coverage_percent": 35,
      "critical_untested_functions": [
        "Real-time callback performance",
        "Device error handling",
        "Buffer underrun recovery"
      ],
      "has_error_tests": false,
      "has_edge_case_tests": false,
      "notes": "Audio output with limited testing due to hardware dependency"
    },
    {
      "module": "audio/types.rs",
      "lines_of_code": 596,
      "test_count": 23,
      "estimated_coverage_percent": 90,
      "critical_untested_functions": [],
      "has_error_tests": true,
      "has_edge_case_tests": true,
      "notes": "Excellent coverage of core data types and operations"
    },
    {
      "module": "audio/resampler.rs",
      "lines_of_code": 253,
      "test_count": 6,
      "estimated_coverage_percent": 70,
      "critical_untested_functions": [],
      "has_error_tests": true,
      "has_edge_case_tests": true,
      "notes": "Good coverage of resampling logic"
    },
    {
      "module": "api/handlers.rs",
      "lines_of_code": 852,
      "test_count": 0,
      "estimated_coverage_percent": 40,
      "critical_untested_functions": [
        "Error response formatting",
        "Invalid request handling",
        "Concurrent request handling"
      ],
      "has_error_tests": false,
      "has_edge_case_tests": false,
      "notes": "No unit tests. Covered by integration tests in tests/api_integration.rs (15 tests)"
    },
    {
      "module": "api/server.rs",
      "lines_of_code": 103,
      "test_count": 0,
      "estimated_coverage_percent": 30,
      "critical_untested_functions": [
        "Server startup",
        "Graceful shutdown"
      ],
      "has_error_tests": false,
      "has_edge_case_tests": false,
      "notes": "Server initialization, covered by integration tests"
    },
    {
      "module": "api/sse.rs",
      "lines_of_code": 80,
      "test_count": 0,
      "estimated_coverage_percent": 25,
      "critical_untested_functions": [
        "SSE connection lifecycle",
        "Event serialization"
      ],
      "has_error_tests": false,
      "has_edge_case_tests": false,
      "notes": "SSE implementation with no direct tests"
    },
    {
      "module": "db/settings.rs",
      "lines_of_code": 708,
      "test_count": 14,
      "estimated_coverage_percent": 80,
      "critical_untested_functions": [],
      "has_error_tests": true,
      "has_edge_case_tests": true,
      "notes": "Strong database settings coverage"
    },
    {
      "module": "db/passages.rs",
      "lines_of_code": 424,
      "test_count": 5,
      "estimated_coverage_percent": 60,
      "critical_untested_functions": [
        "SQL injection protection",
        "Concurrent access patterns"
      ],
      "has_error_tests": true,
      "has_edge_case_tests": false,
      "notes": "Basic database operations tested"
    },
    {
      "module": "db/passage_songs.rs",
      "lines_of_code": 397,
      "test_count": 7,
      "estimated_coverage_percent": 70,
      "critical_untested_functions": [],
      "has_error_tests": true,
      "has_edge_case_tests": true,
      "notes": "Good coverage of database joins and queries"
    },
    {
      "module": "db/queue.rs",
      "lines_of_code": 459,
      "test_count": 4,
      "estimated_coverage_percent": 55,
      "critical_untested_functions": [
        "Queue overflow scenarios",
        "Transaction rollback"
      ],
      "has_error_tests": false,
      "has_edge_case_tests": false,
      "notes": "Basic queue operations covered"
    },
    {
      "module": "db/init.rs",
      "lines_of_code": 263,
      "test_count": 3,
      "estimated_coverage_percent": 60,
      "critical_untested_functions": [],
      "has_error_tests": true,
      "has_edge_case_tests": false,
      "notes": "Database initialization tested"
    },
    {
      "module": "config.rs",
      "lines_of_code": 193,
      "test_count": 1,
      "estimated_coverage_percent": 40,
      "critical_untested_functions": [
        "Invalid TOML parsing",
        "Missing config file handling"
      ],
      "has_error_tests": false,
      "has_edge_case_tests": false,
      "notes": "Configuration loading minimally tested"
    },
    {
      "module": "state.rs",
      "lines_of_code": 169,
      "test_count": 3,
      "estimated_coverage_percent": 70,
      "critical_untested_functions": [],
      "has_error_tests": false,
      "has_edge_case_tests": false,
      "notes": "Application state management"
    },
    {
      "module": "playback/events.rs",
      "lines_of_code": 119,
      "test_count": 4,
      "estimated_coverage_percent": 80,
      "critical_untested_functions": [],
      "has_error_tests": true,
      "has_edge_case_tests": true,
      "notes": "Event types well tested"
    },
    {
      "module": "main.rs",
      "lines_of_code": 149,
      "test_count": 0,
      "estimated_coverage_percent": 0,
      "critical_untested_functions": [
        "Application startup",
        "Signal handling"
      ],
      "has_error_tests": false,
      "has_edge_case_tests": false,
      "notes": "Entry point, not unit tested (typical pattern)"
    },
    {
      "module": "error.rs",
      "lines_of_code": 74,
      "test_count": 0,
      "estimated_coverage_percent": 50,
      "critical_untested_functions": [],
      "has_error_tests": false,
      "has_edge_case_tests": false,
      "notes": "Error types, implicitly tested through other tests"
    }
  ],

  "integration_test_coverage": [
    {
      "test_file": "tests/api_integration.rs",
      "test_count": 15,
      "coverage_area": "HTTP API endpoints",
      "quality": "high",
      "notes": "Comprehensive API endpoint testing including volume control, queue operations, playback control"
    },
    {
      "test_file": "tests/audio_format_tests.rs",
      "test_count": 14,
      "coverage_area": "Multi-format audio decoding",
      "quality": "high",
      "notes": "Tests MP3, FLAC, AAC, Opus, Vorbis, WAV formats with real fixture files"
    },
    {
      "test_file": "tests/playback_engine_integration.rs",
      "test_count": 8,
      "coverage_area": "Playback engine orchestration",
      "quality": "medium",
      "notes": "Basic engine lifecycle and state transitions"
    },
    {
      "test_file": "tests/crossfade_integration_tests.rs",
      "test_count": 7,
      "coverage_area": "Crossfade timing and quality",
      "quality": "high",
      "notes": "RMS tracking, timing verification, fade curve validation"
    },
    {
      "test_file": "tests/audio_subsystem_test.rs",
      "test_count": 6,
      "coverage_area": "Audio subsystem components",
      "quality": "medium",
      "notes": "Basic component integration"
    },
    {
      "test_file": "tests/crossfade_test.rs",
      "test_count": 2,
      "coverage_area": "Basic crossfade operations",
      "quality": "medium",
      "notes": "Early crossfade tests, supplemented by crossfade_integration_tests.rs"
    },
    {
      "test_file": "tests/audible_crossfade_test.rs",
      "test_count": 1,
      "coverage_area": "Audible crossfade quality",
      "quality": "high",
      "notes": "Human-in-the-loop test with real audio playback (ignored by default)"
    }
  ],

  "benchmark_coverage": {
    "has_benchmarks": true,
    "benchmark_file": "benches/crossfade_bench.rs",
    "benchmark_areas": [
      "Fade curve calculations (5 curve types)",
      "Crossfade mixing throughput (1ms to 1s buffers)",
      "Timing precision (0.02ms requirement)",
      "Buffer operations (allocation, copy, clear)",
      "Parallel processing simulation",
      "Real-time constraints (audio callback simulation)"
    ],
    "uses_criterion": true,
    "notes": "Comprehensive performance benchmarks for crossfade operations"
  },

  "critical_gaps": [
    {
      "gap": "No startup time benchmarks or tests",
      "severity": "CRITICAL",
      "impact": "Cannot measure Phase 5 goal (<100ms startup). Current analysis shows >3s delay.",
      "affected_modules": ["main.rs", "playback/engine.rs", "api/server.rs"],
      "recommendation": "Add startup benchmark measuring time from main() to first audio output. Target: <100ms per requirements."
    },
    {
      "gap": "Minimal decoder error recovery tests",
      "severity": "HIGH",
      "impact": "Cannot verify graceful handling of corrupt files, unsupported formats, or I/O errors",
      "affected_modules": ["audio/decoder.rs", "playback/decoder_pool.rs"],
      "recommendation": "Add tests for corrupt files, missing files, unsupported codecs, mid-decode failures"
    },
    {
      "gap": "No memory leak detection tests",
      "severity": "HIGH",
      "impact": "Long-running playback may accumulate memory leaks undetected",
      "affected_modules": ["playback/engine.rs", "playback/buffer_manager.rs"],
      "recommendation": "Add long-running stress test (1000+ passage playback) with memory monitoring"
    },
    {
      "gap": "No buffer underrun/overflow tests",
      "severity": "HIGH",
      "impact": "Cannot verify robust handling of real-time audio constraints",
      "affected_modules": ["audio/output.rs", "playback/ring_buffer.rs"],
      "recommendation": "Add tests simulating slow decode, fast consumption, buffer starvation scenarios"
    },
    {
      "gap": "Limited thread safety verification",
      "severity": "MEDIUM",
      "impact": "Potential race conditions in concurrent playback scenarios",
      "affected_modules": ["playback/buffer_manager.rs", "playback/decoder_pool.rs"],
      "recommendation": "Add concurrent access stress tests, use loom for lock-free code verification"
    },
    {
      "gap": "No API authentication/authorization tests",
      "severity": "MEDIUM",
      "impact": "Security vulnerabilities in multi-user scenarios",
      "affected_modules": ["api/handlers.rs", "api/server.rs"],
      "recommendation": "Add tests for unauthorized access, CSRF protection, rate limiting"
    },
    {
      "gap": "Missing SSE connection lifecycle tests",
      "severity": "MEDIUM",
      "impact": "Cannot verify SSE reconnection, event ordering, or backpressure handling",
      "affected_modules": ["api/sse.rs"],
      "recommendation": "Add tests for client disconnect/reconnect, event buffering, concurrent clients"
    },
    {
      "gap": "No configuration validation tests",
      "severity": "LOW",
      "impact": "Invalid TOML may cause runtime errors instead of clear startup failures",
      "affected_modules": ["config.rs"],
      "recommendation": "Add tests for malformed TOML, missing required fields, invalid values"
    },
    {
      "gap": "Limited crossfade audio artifact detection",
      "severity": "MEDIUM",
      "impact": "Cannot automatically detect clicks, pops, or phase cancellation",
      "affected_modules": ["playback/pipeline/mixer.rs"],
      "recommendation": "Add automated audio quality tests: THD+N, peak detection, spectral analysis"
    },
    {
      "gap": "No property-based tests",
      "severity": "LOW",
      "impact": "May miss edge cases in mathematical operations (timing, resampling, mixing)",
      "affected_modules": ["audio/resampler.rs", "playback/pipeline/timing.rs"],
      "recommendation": "Add proptest for timing calculations, sample rate conversions, volume scaling"
    }
  ],

  "test_infrastructure": {
    "has_test_fixtures": true,
    "fixture_details": {
      "audio_files": [
        "test_audio_10s_wav.wav (1.7MB)",
        "test_audio_10s_flac.flac (130KB)",
        "test_audio_10s_mp3.mp3 (242KB)",
        "test_audio_10s_vorbis.ogg (47KB)",
        "test_audio_10s_opus.opus (164KB)",
        "test_audio_10s_aac.m4a (136KB)"
      ],
      "fixture_location": "tests/fixtures/audio/"
    },
    "has_mock_audio_files": true,
    "has_audio_analysis_tools": true,
    "audio_analysis_details": {
      "rms_tracking": true,
      "clipping_detection": true,
      "timing_verification": true,
      "sine_wave_generation": true,
      "spectral_analysis": false
    },
    "has_performance_framework": true,
    "performance_framework": "criterion v0.5",
    "has_ci_integration": false,
    "test_helpers": [
      "AudioLevelTracker (RMS monitoring)",
      "Sine wave buffer generation",
      "Silent buffer generation",
      "Mock audio output",
      "Test database creation"
    ]
  },

  "test_quality_assessment": {
    "overall_quality": "good",
    "strengths": [
      "Comprehensive crossfade testing with RMS and timing validation",
      "Good unit test coverage for core data types and buffer management",
      "Multi-format audio decoding integration tests with real files",
      "Performance benchmarks using industry-standard criterion framework",
      "Async test infrastructure using tokio::test",
      "Test fixtures for all major audio formats"
    ],
    "weaknesses": [
      "No startup performance benchmarks (critical gap for <100ms goal)",
      "Limited error recovery and edge case testing",
      "Minimal testing of decoder_pool worker lifecycle",
      "No long-running stress tests for memory leak detection",
      "Limited concurrent access and thread safety tests",
      "No automated audio quality analysis (THD+N, spectral)",
      "API handlers tested only via integration tests",
      "No CI/CD integration visible in repository"
    ]
  },

  "recommendations": {
    "immediate_priority": [
      {
        "action": "Add startup time benchmark",
        "rationale": "Required to measure progress toward <100ms Phase 5 goal",
        "effort": "medium",
        "file": "benches/startup_bench.rs"
      },
      {
        "action": "Add corrupt file handling tests",
        "rationale": "Critical for production robustness",
        "effort": "low",
        "file": "tests/decoder_error_handling.rs"
      },
      {
        "action": "Add long-running stress test",
        "rationale": "Detect memory leaks before production deployment",
        "effort": "medium",
        "file": "tests/stress_test.rs"
      }
    ],
    "high_priority": [
      {
        "action": "Add buffer underrun tests",
        "rationale": "Verify real-time audio reliability",
        "effort": "medium",
        "file": "tests/audio_underrun_test.rs"
      },
      {
        "action": "Add SSE lifecycle tests",
        "rationale": "Ensure robust real-time UI updates",
        "effort": "low",
        "file": "tests/sse_integration.rs"
      },
      {
        "action": "Add decoder_pool concurrency tests",
        "rationale": "Verify thread pool safety",
        "effort": "medium",
        "file": "src/playback/decoder_pool.rs (add tests module)"
      }
    ],
    "medium_priority": [
      {
        "action": "Add property-based tests for timing calculations",
        "rationale": "Catch edge cases in sample-accurate timing",
        "effort": "low",
        "file": "src/playback/pipeline/timing.rs (add proptest)"
      },
      {
        "action": "Add automated audio quality tests",
        "rationale": "Detect crossfade artifacts automatically",
        "effort": "high",
        "file": "tests/audio_quality_analysis.rs"
      },
      {
        "action": "Set up CI/CD with coverage tracking",
        "rationale": "Prevent regression and monitor coverage trends",
        "effort": "medium",
        "file": ".github/workflows/ci.yml"
      }
    ]
  },

  "coverage_metrics": {
    "files_with_tests": 25,
    "files_without_tests": 7,
    "modules_with_zero_tests": [
      "api/handlers.rs (covered by integration tests)",
      "api/server.rs (covered by integration tests)",
      "api/sse.rs (no coverage)",
      "main.rs (typical - entry point)",
      "error.rs (implicit coverage)",
      "playback/types.rs (data types)",
      "audio/mod.rs (re-exports only)"
    ],
    "test_to_code_ratio": 0.164,
    "notes": "226 tests for 13,719 lines = 16.4 tests per 1000 lines"
  },

  "comparison_to_industry_standards": {
    "typical_rust_coverage": "60-80%",
    "wkmp_ap_estimated_coverage": "65%",
    "assessment": "Slightly below typical, but acceptable for early-stage development",
    "critical_path_coverage": "75%",
    "notes": "Core playback and crossfade logic well-tested. Infrastructure (API, SSE, startup) needs attention."
  },

  "next_steps": [
    "Implement startup time benchmark (highest priority)",
    "Add decoder error handling tests",
    "Create long-running stress test for memory leak detection",
    "Add buffer underrun/overflow simulation tests",
    "Consider cargo-tarpaulin for actual coverage measurement",
    "Set up GitHub Actions CI with test execution"
  ]
}
